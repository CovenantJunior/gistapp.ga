function unique(){return"x"+ ++NOW+ +new Date}function rnow(){return+new Date}function build_url(a,b){var c=a.join(URLBIT),d=[];return b?(each(b,function(a,b){var c="object"==typeof b?JSON.stringify(b):b;"undefined"!=typeof b&&null!=b&&encode(c).length>0&&d.push(a+"="+encode(c))}),c+="?"+d.join(PARAMSBIT)):c}function updater(a,b){var c,d=0,e=function(){d+b>rnow()?(clearTimeout(c),c=setTimeout(e,b)):(d=rnow(),a())};return e}function grep(a,b){var c=[];return each(a||[],function(a){b(a)&&c.push(a)}),c}function supplant(a,b){return a.replace(REPL,function(a,c){return b[c]||a})}function timeout(a,b){return setTimeout(a,b)}function uuid(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)});return a&&a(b),b}function isArray(a){return!!a&&(Array.isArray&&Array.isArray(a)||"number"==typeof a.length)}function each(a,b){if(a&&b)if(isArray(a))for(var c=0,d=a.length;d>c;)b.call(a[c],a[c],c++);else for(var c in a)a.hasOwnProperty&&a.hasOwnProperty(c)&&b.call(a[c],c,a[c])}function map(a,b){var c=[];return each(a||[],function(a,d){c.push(b(a,d))}),c}function encode(a){return encodeURIComponent(a)}function generate_channel_list(a,b){var c=[];return each(a,function(a,d){b?a.search("-pnpres")<0&&d.subscribed&&c.push(a):d.subscribed&&c.push(a)}),c.sort()}function ready(){timeout(function(){READY||(READY=1,each(READY_BUFFER,function(a){a()}))},SECOND)}function PN_API(a){function b(a){return a||(a={}),each(Y,function(b,c){a[b]=c}),a}function c(a){var b=[];return each(a,function(a){b.push(a)}),b}function d(a){return c(a).sort()}function e(a){var b="",c=d(a);for(var e in c){var f=c[e];b+=f+"="+encode(a[f]),e!=c.length-1&&(b+="&")}return b}function f(a,b,c){var d=!1;if("number"==typeof a)d=a>PRESENCE_HB_THRESHOLD||0==a?!1:!0;else{if("boolean"==typeof a)return a?PRESENCE_HB_DEFAULT:0;d=!0}return d?(c&&c("Presence Heartbeat value invalid. Valid range ( x > "+PRESENCE_HB_THRESHOLD+" or x = 0). Current Value : "+(b||PRESENCE_HB_THRESHOLD)),b||PRESENCE_HB_THRESHOLD):a}function g(a,b){return db.encrypt(a,b||bb)||a}function h(a,b){return db.decrypt(a,b||bb)||db.decrypt(a,bb)||a}function i(){return clearTimeout(R),!T||T>=500||1>T||!generate_channel_list(P,!0).length?void(U=!1):(U=!0,void eb.presence_heartbeat({callback:function(){R=timeout(i,T*SECOND)},error:function(a){Z&&Z("Presence Heartbeat unable to reach Pubnub servers."+JSON.stringify(a)),R=timeout(i,T*SECOND)}}))}function j(){!U&&i()}function k(a){if(V){if(!H.length)return}else{if(a&&(H.sending=0),H.sending||!H.length)return;H.sending=1}X(H.shift())}function l(a){var b=0;return each(generate_channel_list(P),function(c){var d=P[c];d&&(b++,(a||function(){})(d))}),b}function m(a,b,c){if("object"==typeof a){if(a.error&&a.message&&a.payload)return void c({message:a.message,payload:a.payload});if(a.payload)return void b(a.payload)}b(a)}function n(a,b){b("object"==typeof a&&a.error&&a.message&&a.payload?{message:a.message,payload:a.payload}:a)}function o(){$()||q(1,{error:"Offline. Please check your network settings. "}),timeout(o,SECOND)}function p(){eb.time(function(a){s(function(){},a),a||q(1,{error:"Heartbeat failed to connect to Pubnub Servers.Please check your network settings."}),timeout(p,v)})}function q(a,b){L&&L(a,b),L=null}function r(a){var b=rnow()-I;return b-a/1e4}function s(a,b){function c(b){if(b){var c=b/1e4,e=(rnow()-d)/2;I=rnow()-(c+e),a&&a(I)}}var d=rnow();b&&c(b)||eb.time(c)}var t=+a.windowing||DEF_WINDOWING,u=(+a.timeout||DEF_SUB_TIMEOUT)*SECOND,v=(+a.keepalive||DEF_KEEPALIVE)*SECOND,w=a.noleave||0,x=a.publish_key||"demo",y=a.subscribe_key||"demo",z=a.auth_key||"",A=a.secret_key||"",B=a.hmac_SHA256,C=a.ssl?"s":"",D="http"+C+"://"+(a.origin||"pubsub.pubnub.com"),E=nextorigin(D),F=nextorigin(D),G=function(){},H=[],I=0,J=0,K=0,L=0,M=0,N=0,O=!1,P={},Q={},R=null,S=f(a.heartbeat||a.pnexpires||0,a.error),T=a.heartbeat_interval||S-3,U=!1,V=a.no_wait_for_pending,W=a["compatible_3.5"]||!1,X=a.xdr,Y=a.params||{},Z=a.error||function(){},$=a._is_online||function(){return 1},_=a.jsonp_cb||function(){return 0},ab=a.db||{get:function(){},set:function(){}},bb=a.cipher_key,cb=a.uuid||ab&&ab.get(y+"uuid")||"",db=a.crypto_obj||{encrypt:function(a){return a},decrypt:function(a){return a}},eb={LEAVE:function(a,c,d,e){var f={uuid:cb,auth:z},g=nextorigin(D),d=d||function(){},h=e||function(){},i=_();if(a.indexOf(PRESENCE_SUFFIX)>0)return!0;if(W){if(!C)return!1;if("0"==i)return!1}return w?!1:("0"!=i&&(f.callback=i),X({blocking:c||C,timeout:2e3,callback:i,data:b(f),success:function(a){m(a,d,h)},fail:function(a){n(a,h)},url:[g,"v2","presence","sub_key",y,"channel",encode(a),"leave"]}),!0)},set_resumed:function(a){O=a},get_cipher_key:function(){return bb},set_cipher_key:function(a){bb=a},raw_encrypt:function(a,b){return g(a,b)},raw_decrypt:function(a,b){return h(a,b)},get_heartbeat:function(){return S},set_heartbeat:function(a){S=f(a,T,Z),T=S-3>=1?S-3:1,G(),i()},get_heartbeat_interval:function(){return T},set_heartbeat_interval:function(a){T=a,i()},get_version:function(){return SDK_VER},_add_param:function(a,b){Y[a]=b},history:function(a,c){var c=a.callback||c,d=a.count||a.limit||100,e=a.reverse||"false",f=a.error||function(){},g=a.auth_key||z,i=a.cipher_key,j=a.channel,k=a.start,l=a.end,m=a.include_token,o={},p=_();return j?c?y?(o.stringtoken="true",o.count=d,o.reverse=e,o.auth=g,p&&(o.callback=p),k&&(o.start=k),l&&(o.end=l),m&&(o.include_token="true"),void X({callback:p,data:b(o),success:function(a){if("object"==typeof a&&a.error)return void f({message:a.message,payload:a.payload});for(var b=a[0],d=[],e=0;e<b.length;e++){var g=h(b[e],i);try{d.push(JSON.parse(g))}catch(j){d.push(g)}}c([d,a[1],a[2]])},fail:function(a){n(a,f)},url:[E,"v2","history","sub-key",y,"channel",encode(j)]})):Z("Missing Subscribe Key"):Z("Missing Callback"):Z("Missing Channel")},replay:function(a,c){var d,c=c||a.callback||function(){},e=a.auth_key||z,f=a.source,g=a.destination,h=a.stop,i=a.start,j=a.end,k=a.reverse,l=a.limit,n=_(),o={};return f?g?x?y?("0"!=n&&(o.callback=n),h&&(o.stop="all"),k&&(o.reverse="true"),i&&(o.start=i),j&&(o.end=j),l&&(o.count=l),o.auth=e,d=[E,"v1","replay",x,y,f,g],void X({callback:n,success:function(a){m(a,c,err)},fail:function(){c([0,"Disconnected"])},url:d,data:b(o)})):Z("Missing Subscribe Key"):Z("Missing Publish Key"):Z("Missing Destination Channel"):Z("Missing Source Channel")},auth:function(a){z=a,G()},time:function(a){var c=_();X({callback:c,data:b({uuid:cb,auth:z}),timeout:5*SECOND,url:[E,"time",c],success:function(b){a(b[0])},fail:function(){a(0)}})},publish:function(a,c){var d,c=c||a.callback||function(){},e=a.message,f=a.channel,h=a.auth_key||z,i=a.cipher_key,j=a.error||function(){},l=a.post||!1,o=_(),p="push";return a.prepend&&(p="unshift"),e?f?x?y?(e=JSON.stringify(g(e,i)),d=[E,"publish",x,y,0,encode(f),o,encode(e)],H[p]({callback:o,timeout:5*SECOND,url:d,data:b({uuid:cb,auth:h}),fail:function(a){n(a,j),k(1)},success:function(a){m(a,c,j),k(1)},mode:l?"POST":"GET"}),void k()):Z("Missing Subscribe Key"):Z("Missing Publish Key"):Z("Missing Channel"):Z("Missing Message")},unsubscribe:function(a,b){var c=a.channel,b=b||a.callback||function(){},d=a.error||function(){};N=0,M=1,c=map((c.join?c.join(","):""+c).split(","),function(a){return P[a]?a+","+a+PRESENCE_SUFFIX:void 0}).join(","),each(c.split(","),function(a){var c=!0;a&&(READY&&(c=eb.LEAVE(a,0,b,d)),c||b({action:"leave"}),P[a]=0,a in Q&&delete Q[a])}),G()},subscribe:function(a,c){function d(a){a?timeout(G,SECOND):(E=nextorigin(D,1),F=nextorigin(D,1),timeout(function(){eb.time(d)},SECOND)),l(function(b){return a&&b.disconnected?(b.disconnected=0,b.reconnect(b.name)):void(a||b.disconnected||(b.disconnected=1,b.disconnect(b.name)))})}function e(){var a=_(),c=generate_channel_list(P).join(",");if(c){q();var f=b({uuid:cb,auth:g}),i=JSON.stringify(Q);i.length>2&&(f.state=JSON.stringify(Q)),S&&(f.heartbeat=S),j(),L=X({timeout:A,callback:a,fail:function(a){n(a,o),eb.time(d)},data:b(f),url:[F,"subscribe",y,encode(c),a,N],success:function(a){if(!a||"object"==typeof a&&"error"in a&&a.error)return o(a.error),timeout(G,SECOND);if(p(a[1]),N=!N&&M&&ab.get(y)||a[1],l(function(a){a.connected||(a.connected=1,a.connect(a.name))}),O&&!M)return N=0,O=!1,ab.set(y,0),void timeout(e,B);w&&(N=1e4,w=0),ab.set(y,a[1]);var b=function(){var b=a.length>2?a[2]:map(generate_channel_list(P),function(b){return map(Array(a[0].length).join(",").split(","),function(){return b})}).join(","),c=b.split(",");return function(){var a=c.shift()||K;return[(P[a]||{}).callback||J,a.split(PRESENCE_SUFFIX)[0]]}}(),c=r(+a[1]);each(a[0],function(d){var e=b(),f=h(d,P[e[1]].cipher_key);e[0](f,a,e[1],c)}),timeout(e,B)}})}}var f=a.channel,c=c||a.callback,c=c||a.message,g=a.auth_key||z,i=a.connect||function(){},k=a.reconnect||function(){},m=a.disconnect||function(){},o=a.error||function(){},p=a.idle||function(){},s=a.presence||0,v=a.noheresync||0,w=a.backfill||0,x=a.timetoken||0,A=a.timeout||u,B=a.windowing||t,C=a.state,H=a.heartbeat||a.pnexpires,I=a.restore;return M=I,N=x,f?c?y?((H||0===H)&&eb.set_heartbeat(H),each((f.join?f.join(","):""+f).split(","),function(b){var d=P[b]||{};P[K=b]={name:b,connected:d.connected,disconnected:d.disconnected,subscribed:1,callback:J=c,cipher_key:a.cipher_key,connect:i,disconnect:m,reconnect:k},C&&(Q[b]=b in C?C[b]:C),s&&(eb.subscribe({channel:b+PRESENCE_SUFFIX,callback:s,restore:I}),d.subscribed||v||eb.here_now({channel:b,callback:function(a){each("uuids"in a?a.uuids:[],function(c){s({action:"join",uuid:c,timestamp:rnow(),occupancy:a.occupancy||1},a,b)})}}))}),G=function(){q(),timeout(e,B)},READY?void G():READY_BUFFER.push(G)):Z("Missing Subscribe Key"):Z("Missing Callback"):Z("Missing Channel")},here_now:function(a,c){var c=a.callback||c,d=a.error||function(){},e=a.auth_key||z,f=a.channel,g=_(),h="uuids"in a?a.uuids:!0,i=a.state,j={uuid:cb,auth:e};if(h||(j.disable_uuids=1),i&&(j.state=1),!c)return Z("Missing Callback");if(!y)return Z("Missing Subscribe Key");var k=[E,"v2","presence","sub_key",y];f&&k.push("channel")&&k.push(encode(f)),"0"!=g&&(j.callback=g),X({callback:g,data:b(j),success:function(a){m(a,c,d)},fail:function(a){n(a,d)},url:k})},where_now:function(a,c){var c=a.callback||c,d=a.error||function(){},e=a.auth_key||z,f=_(),g=a.uuid||cb,h={auth:e};return c?y?("0"!=f&&(h.callback=f),void X({callback:f,data:b(h),success:function(a){m(a,c,d)},fail:function(a){n(a,d)},url:[E,"v2","presence","sub_key",y,"uuid",encode(g)]})):Z("Missing Subscribe Key"):Z("Missing Callback")},state:function(a,c){var d,c=a.callback||c||function(){},e=a.error||function(){},f=a.auth_key||z,g=_(),h=a.state,i=a.uuid||cb,j=a.channel,k=b({auth:f});return y?i?j?("0"!=g&&(k.callback=g),P[j]&&P[j].subscribed&&(Q[j]=h),k.state=JSON.stringify(h),d=h?[E,"v2","presence","sub-key",y,"channel",encode(j),"uuid",i,"data"]:[E,"v2","presence","sub-key",y,"channel",encode(j),"uuid",encode(i)],void X({callback:g,data:b(k),success:function(a){m(a,c,e)},fail:function(a){n(a,e)},url:d})):Z("Missing Channel"):Z("Missing UUID"):Z("Missing Subscribe Key")},grant:function(a,c){var c=a.callback||c,d=a.error||function(){},f=a.channel,g=_(),h=a.ttl,i=a.read?"1":"0",j=a.write?"1":"0",k=a.auth_key;if(!f)return Z("Missing Channel");if(!c)return Z("Missing Callback");if(!y)return Z("Missing Subscribe Key");if(!x)return Z("Missing Publish Key");if(!A)return Z("Missing Secret Key");var l=Math.floor((new Date).getTime()/1e3),o=y+"\n"+x+"\ngrant\n",p={w:j,r:i,channel:f,timestamp:l};"0"!=g&&(p.callback=g),(h||0===h)&&(p.ttl=h),k&&(p.auth=k),p=b(p),o+=e(p);var q=B(o,A);q=q.replace(/\+/g,"-"),q=q.replace(/\//g,"_"),p.signature=q,X({callback:g,data:p,success:function(a){m(a,c,d)},fail:function(a){n(a,d)},url:[E,"v1","auth","grant","sub-key",y]})},audit:function(a,c){var c=a.callback||c,d=a.error||function(){},f=a.channel,g=a.auth_key,h=_();if(!c)return Z("Missing Callback");if(!y)return Z("Missing Subscribe Key");if(!x)return Z("Missing Publish Key");if(!A)return Z("Missing Secret Key");var i=Math.floor((new Date).getTime()/1e3),j=y+"\n"+x+"\naudit\n",k={timestamp:i};"0"!=h&&(k.callback=h),f&&(k.channel=f),g&&(k.auth=g),k=b(k),j+=e(k);var l=B(j,A);l=l.replace(/\+/g,"-"),l=l.replace(/\//g,"_"),k.signature=l,X({callback:h,data:k,success:function(a){m(a,c,d)},fail:function(a){n(a,d)},url:[E,"v1","auth","audit","sub-key",y]})},revoke:function(a,b){a.read=!1,a.write=!1,eb.grant(a,b)},set_uuid:function(a){cb=a,G()},get_uuid:function(){return cb},presence_heartbeat:function(a){var c=a.callback||function(){},d=a.error||function(){},e=_(),f={uuid:cb,auth:z},g=JSON.stringify(Q);g.length>2&&(f.state=JSON.stringify(Q)),S>0&&320>S&&(f.heartbeat=S),X({callback:e,data:b(f),timeout:5*SECOND,url:[E,"v2","presence","sub-key",y,"channel",encode(generate_channel_list(P,!0).join(",")),"heartbeat"],success:function(a){m(a,c,d)},fail:function(a){n(a,d)}})},xdr:X,ready:ready,db:ab,uuid:uuid,map:map,each:each,"each-channel":l,grep:grep,offline:function(){q(1,{message:"Offline. Please check your network settings."})},supplant:supplant,now:rnow,unique:unique,updater:updater};return cb||(cb=eb.uuid()),ab.set(y+"uuid",cb),timeout(o,SECOND),timeout(p,v),R=timeout(j,(T-3)*SECOND),s(),eb}function crypto_obj(){function a(a){function b(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function c(a,b){return a>>>b|a<<32-b}function d(a,b){return a>>>b}function e(a,b,c){return a&b^~a&c}function f(a,b,c){return a&b^a&c^b&c}function g(a){return c(a,2)^c(a,13)^c(a,22)}function h(a){return c(a,6)^c(a,11)^c(a,25)}function i(a){return c(a,7)^c(a,18)^d(a,3)}function j(a){return c(a,17)^c(a,19)^d(a,10)}function k(a,c){var d,k,l,m,n,o,p,q,r,s,t,u,v=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),w=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),x=new Array(64);a[c>>5]|=128<<24-c%32,a[(c+64>>9<<4)+15]=c;for(var r=0;r<a.length;r+=16){d=w[0],k=w[1],l=w[2],m=w[3],n=w[4],o=w[5],p=w[6],q=w[7];for(var s=0;64>s;s++)x[s]=16>s?a[s+r]:b(b(b(j(x[s-2]),x[s-7]),i(x[s-15])),x[s-16]),t=b(b(b(b(q,h(n)),e(n,o,p)),v[s]),x[s]),u=b(g(d),f(d,k,l)),q=p,p=o,o=n,n=b(m,t),m=l,l=k,k=d,d=b(t,u);w[0]=b(d,w[0]),w[1]=b(k,w[1]),w[2]=b(l,w[2]),w[3]=b(m,w[3]),w[4]=b(n,w[4]),w[5]=b(o,w[5]),w[6]=b(p,w[6]),w[7]=b(q,w[7])}return w}function l(a){for(var b=Array(),c=(1<<o)-1,d=0;d<a.length*o;d+=o)b[d>>5]|=(a.charCodeAt(d/o)&c)<<24-d%32;return b}function m(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}function n(a){for(var b=p?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(a[d>>2]>>8*(3-d%4)+4&15)+b.charAt(a[d>>2]>>8*(3-d%4)&15);return c}var o=8,p=0;return a=m(a),n(k(l(a),a.length*o))}var b=CRYPTO;b.size(256);var c=b.s2a("0123456789012345");return{encrypt:function(d,e){if(!e)return d;var f=b.s2a(a(e).slice(0,32)),g=b.s2a(JSON.stringify(d)),h=b.rawEncrypt(g,f,c),i=b.Base64.encode(h);return i||d},decrypt:function(d,e){if(!e)return d;var f=b.s2a(a(e).slice(0,32));try{var g=b.Base64.decode(d),h=b.rawDecrypt(g,f,c,!1),i=JSON.parse(h);return i}catch(j){return void 0}}}}window.JSON&&window.JSON.stringify||function(){function toJSON(){try{return this.valueOf()}catch(a){return null}}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&(i=toJSON.call(i,a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}window.JSON||(window.JSON={});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text){return eval("("+text+")")})}();var NOW=1,READY=!1,READY_BUFFER=[],PRESENCE_SUFFIX="-pnpres",DEF_WINDOWING=10,DEF_TIMEOUT=1e4,DEF_SUB_TIMEOUT=310,DEF_KEEPALIVE=60,SECOND=1e3,URLBIT="/",PARAMSBIT="&",PRESENCE_HB_THRESHOLD=5,PRESENCE_HB_DEFAULT=30,SDK_VER="3.6.4",REPL=/{([\w\-]+)}/g,nextorigin=function(){var a=20,b=Math.floor(Math.random()*a);return function(c,d){return c.indexOf("pubsub.")>0&&c.replace("pubsub","ps"+(d?uuid().split("-")[0]:++b<a?b:b=1))||c}}(),CRYPTO=function(){var a=14,b=8,c=!1,d=function(a){try{return unescape(encodeURIComponent(a))}catch(b){throw"Error on UTF-8 encode"}},e=function(a){try{return decodeURIComponent(escape(a))}catch(b){throw"Bad Key"}},f=function(a){var b,c,d=[];for(a.length<16&&(b=16-a.length,d=[b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b]),c=0;c<a.length;c++)d[c]=a[c];return d},g=function(a,b){var c,d,e="";if(b){if(c=a[15],c>16)throw"Decryption error: Maybe bad key";if(16==c)return"";for(d=0;16-c>d;d++)e+=String.fromCharCode(a[d])}else for(d=0;16>d;d++)e+=String.fromCharCode(a[d]);return e},h=function(a){var b,c="";for(b=0;b<a.length;b++)c+=(a[b]<16?"0":"")+a[b].toString(16);return c},j=function(a){var b=[];return a.replace(/(..)/g,function(a){b.push(parseInt(a,16))}),b},k=function(a,b){var c,e=[];for(b||(a=d(a)),c=0;c<a.length;c++)e[c]=a.charCodeAt(c);return e},l=function(c){switch(c){case 128:a=10,b=4;break;case 192:a=12,b=6;break;case 256:a=14,b=8;break;default:throw"Invalid Key Size Specified:"+c}},m=function(a){var b,c=[];for(b=0;a>b;b++)c=c.concat(Math.floor(256*Math.random()));return c},n=function(c,d){var e,f=a>=12?3:2,g=[],h=[],i=[],j=[],k=c.concat(d);for(i[0]=GibberishAES.Hash.MD5(k),j=i[0],e=1;f>e;e++)i[e]=GibberishAES.Hash.MD5(i[e-1].concat(k)),j=j.concat(i[e]);return g=j.slice(0,4*b),h=j.slice(4*b,4*b+16),{key:g,iv:h}},o=function(a,b,c){b=x(b);var d,e=Math.ceil(a.length/16),g=[],h=[];for(d=0;e>d;d++)g[d]=f(a.slice(16*d,16*d+16));for(a.length%16===0&&(g.push([16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16]),e++),d=0;d<g.length;d++)g[d]=0===d?w(g[d],c):w(g[d],h[d-1]),h[d]=q(g[d],b);return h},p=function(a,b,c,d){b=x(b);var f,h=a.length/16,i=[],j=[],k="";for(f=0;h>f;f++)i.push(a.slice(16*f,16*(f+1)));for(f=i.length-1;f>=0;f--)j[f]=r(i[f],b),j[f]=0===f?w(j[f],c):w(j[f],i[f-1]);for(f=0;h-1>f;f++)k+=g(j[f]);return k+=g(j[f],!0),d?k:e(k)},q=function(b,d){c=!1;var e,f=v(b,d,0);for(e=1;a+1>e;e++)f=s(f),f=t(f),a>e&&(f=u(f)),f=v(f,d,e);return f},r=function(b,d){c=!0;var e,f=v(b,d,a);for(e=a-1;e>-1;e--)f=t(f),f=s(f),f=v(f,d,e),e>0&&(f=u(f));return f},s=function(a){var b,d=c?F:E,e=[];for(b=0;16>b;b++)e[b]=d[a[b]];return e},t=function(a){var b,d=[],e=c?[0,13,10,7,4,1,14,11,8,5,2,15,12,9,6,3]:[0,5,10,15,4,9,14,3,8,13,2,7,12,1,6,11];for(b=0;16>b;b++)d[b]=a[e[b]];return d},u=function(a){var b,d=[];if(c)for(b=0;4>b;b++)d[4*b]=M[a[4*b]]^K[a[1+4*b]]^L[a[2+4*b]]^J[a[3+4*b]],d[1+4*b]=J[a[4*b]]^M[a[1+4*b]]^K[a[2+4*b]]^L[a[3+4*b]],d[2+4*b]=L[a[4*b]]^J[a[1+4*b]]^M[a[2+4*b]]^K[a[3+4*b]],d[3+4*b]=K[a[4*b]]^L[a[1+4*b]]^J[a[2+4*b]]^M[a[3+4*b]];else for(b=0;4>b;b++)d[4*b]=H[a[4*b]]^I[a[1+4*b]]^a[2+4*b]^a[3+4*b],d[1+4*b]=a[4*b]^H[a[1+4*b]]^I[a[2+4*b]]^a[3+4*b],d[2+4*b]=a[4*b]^a[1+4*b]^H[a[2+4*b]]^I[a[3+4*b]],d[3+4*b]=I[a[4*b]]^a[1+4*b]^a[2+4*b]^H[a[3+4*b]];return d},v=function(a,b,c){var d,e=[];for(d=0;16>d;d++)e[d]=a[d]^b[c][d];return e},w=function(a,b){var c,d=[];for(c=0;16>c;c++)d[c]=a[c]^b[c];return d},x=function(c){var d,e,f,g,h=[],i=[],j=[];for(d=0;b>d;d++)e=[c[4*d],c[4*d+1],c[4*d+2],c[4*d+3]],h[d]=e;for(d=b;4*(a+1)>d;d++){for(h[d]=[],f=0;4>f;f++)i[f]=h[d-1][f];for(d%b===0?(i=y(z(i)),i[0]^=G[d/b-1]):b>6&&d%b==4&&(i=y(i)),f=0;4>f;f++)h[d][f]=h[d-b][f]^i[f]}for(d=0;a+1>d;d++)for(j[d]=[],g=0;4>g;g++)j[d].push(h[4*d+g][0],h[4*d+g][1],h[4*d+g][2],h[4*d+g][3]);return j},y=function(a){for(var b=0;4>b;b++)a[b]=E[a[b]];return a},z=function(a){var b,c=a[0];for(b=0;4>b;b++)a[b]=a[b+1];return a[3]=c,a},A=function(a,b){var c=[];for(i=0;i<a.length;i+=b)c[i/b]=parseInt(a.substr(i,b),16);return c},B=function(a){var b=[];for(i=0;i<a.length;i++)b[a[i]]=i;return b},C=function(a,b){var c,d;for(d=0,c=0;8>c;c++)d=1==(1&b)?d^a:d,a=a>127?283^a<<1:a<<1,b>>>=1;return d},D=function(a){for(var b=[],c=0;256>c;c++)b[c]=C(a,c);return b},E=A("637c777bf26b6fc53001672bfed7ab76ca82c97dfa5947f0add4a2af9ca472c0b7fd9326363ff7cc34a5e5f171d8311504c723c31896059a071280e2eb27b27509832c1a1b6e5aa0523bd6b329e32f8453d100ed20fcb15b6acbbe394a4c58cfd0efaafb434d338545f9027f503c9fa851a3408f929d38f5bcb6da2110fff3d2cd0c13ec5f974417c4a77e3d645d197360814fdc222a908846eeb814de5e0bdbe0323a0a4906245cc2d3ac629195e479e7c8376d8dd54ea96c56f4ea657aae08ba78252e1ca6b4c6e8dd741f4bbd8b8a703eb5664803f60e613557b986c11d9ee1f8981169d98e949b1e87e9ce5528df8ca1890dbfe6426841992d0fb054bb16",2),F=B(E),G=A("01020408102040801b366cd8ab4d9a2f5ebc63c697356ad4b37dfaefc591",2),H=D(2),I=D(3),J=D(9),K=D(11),L=D(13),M=D(14),N=function(a,b,c){var d,e=m(8),f=n(k(b,c),e),g=f.key,h=f.iv,i=[[83,97,108,116,101,100,95,95].concat(e)];return a=k(a,c),d=o(a,g,h),d=i.concat(d),Q.encode(d)},O=function(a,b,c){var d=Q.decode(a),e=d.slice(8,16),f=n(k(b,c),e),g=f.key,h=f.iv;return d=d.slice(16,d.length),a=p(d,g,h,c)},P=function(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=[],h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a[i]<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d=[];for(c=0;3>=c;c++)b=a>>>8*c&255,d=d.concat(b);return d}var n,o,p,q,r,s,t,u,v,w=[],x=A("67452301efcdab8998badcfe10325476d76aa478e8c7b756242070dbc1bdceeef57c0faf4787c62aa8304613fd469501698098d88b44f7afffff5bb1895cd7be6b901122fd987193a679438e49b40821f61e2562c040b340265e5a51e9b6c7aad62f105d02441453d8a1e681e7d3fbc821e1cde6c33707d6f4d50d87455a14eda9e3e905fcefa3f8676f02d98d2a4c8afffa39428771f6816d9d6122fde5380ca4beea444bdecfa9f6bb4b60bebfbc70289b7ec6eaa127fad4ef308504881d05d9d4d039e6db99e51fa27cf8c4ac5665f4292244432aff97ab9423a7fc93a039655b59c38f0ccc92ffeff47d85845dd16fa87e4ffe2ce6e0a30143144e0811a1f7537e82bd3af2352ad7d2bbeb86d391",8);for(w=l(a),s=x[0],t=x[1],u=x[2],v=x[3],n=0;n<w.length;n+=16)o=s,p=t,q=u,r=v,s=h(s,t,u,v,w[n+0],7,x[4]),v=h(v,s,t,u,w[n+1],12,x[5]),u=h(u,v,s,t,w[n+2],17,x[6]),t=h(t,u,v,s,w[n+3],22,x[7]),s=h(s,t,u,v,w[n+4],7,x[8]),v=h(v,s,t,u,w[n+5],12,x[9]),u=h(u,v,s,t,w[n+6],17,x[10]),t=h(t,u,v,s,w[n+7],22,x[11]),s=h(s,t,u,v,w[n+8],7,x[12]),v=h(v,s,t,u,w[n+9],12,x[13]),u=h(u,v,s,t,w[n+10],17,x[14]),t=h(t,u,v,s,w[n+11],22,x[15]),s=h(s,t,u,v,w[n+12],7,x[16]),v=h(v,s,t,u,w[n+13],12,x[17]),u=h(u,v,s,t,w[n+14],17,x[18]),t=h(t,u,v,s,w[n+15],22,x[19]),s=i(s,t,u,v,w[n+1],5,x[20]),v=i(v,s,t,u,w[n+6],9,x[21]),u=i(u,v,s,t,w[n+11],14,x[22]),t=i(t,u,v,s,w[n+0],20,x[23]),s=i(s,t,u,v,w[n+5],5,x[24]),v=i(v,s,t,u,w[n+10],9,x[25]),u=i(u,v,s,t,w[n+15],14,x[26]),t=i(t,u,v,s,w[n+4],20,x[27]),s=i(s,t,u,v,w[n+9],5,x[28]),v=i(v,s,t,u,w[n+14],9,x[29]),u=i(u,v,s,t,w[n+3],14,x[30]),t=i(t,u,v,s,w[n+8],20,x[31]),s=i(s,t,u,v,w[n+13],5,x[32]),v=i(v,s,t,u,w[n+2],9,x[33]),u=i(u,v,s,t,w[n+7],14,x[34]),t=i(t,u,v,s,w[n+12],20,x[35]),s=j(s,t,u,v,w[n+5],4,x[36]),v=j(v,s,t,u,w[n+8],11,x[37]),u=j(u,v,s,t,w[n+11],16,x[38]),t=j(t,u,v,s,w[n+14],23,x[39]),s=j(s,t,u,v,w[n+1],4,x[40]),v=j(v,s,t,u,w[n+4],11,x[41]),u=j(u,v,s,t,w[n+7],16,x[42]),t=j(t,u,v,s,w[n+10],23,x[43]),s=j(s,t,u,v,w[n+13],4,x[44]),v=j(v,s,t,u,w[n+0],11,x[45]),u=j(u,v,s,t,w[n+3],16,x[46]),t=j(t,u,v,s,w[n+6],23,x[47]),s=j(s,t,u,v,w[n+9],4,x[48]),v=j(v,s,t,u,w[n+12],11,x[49]),u=j(u,v,s,t,w[n+15],16,x[50]),t=j(t,u,v,s,w[n+2],23,x[51]),s=k(s,t,u,v,w[n+0],6,x[52]),v=k(v,s,t,u,w[n+7],10,x[53]),u=k(u,v,s,t,w[n+14],15,x[54]),t=k(t,u,v,s,w[n+5],21,x[55]),s=k(s,t,u,v,w[n+12],6,x[56]),v=k(v,s,t,u,w[n+3],10,x[57]),u=k(u,v,s,t,w[n+10],15,x[58]),t=k(t,u,v,s,w[n+1],21,x[59]),s=k(s,t,u,v,w[n+8],6,x[60]),v=k(v,s,t,u,w[n+15],10,x[61]),u=k(u,v,s,t,w[n+6],15,x[62]),t=k(t,u,v,s,w[n+13],21,x[63]),s=k(s,t,u,v,w[n+4],6,x[64]),v=k(v,s,t,u,w[n+11],10,x[65]),u=k(u,v,s,t,w[n+2],15,x[66]),t=k(t,u,v,s,w[n+9],21,x[67]),s=c(s,o),t=c(t,p),u=c(u,q),v=c(v,r);return m(s).concat(m(t),m(u),m(v))},Q=function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b=a.split(""),c=function(a){{var c,d,e=[],f="";Math.floor(16*a.length/3)}for(c=0;c<16*a.length;c++)e.push(a[Math.floor(c/16)][c%16]);for(c=0;c<e.length;c+=3)f+=b[e[c]>>2],f+=b[(3&e[c])<<4|e[c+1]>>4],f+=void 0!==e[c+1]?b[(15&e[c+1])<<2|e[c+2]>>6]:"=",f+=void 0!==e[c+2]?b[63&e[c+2]]:"=";for(d=f.slice(0,64),c=1;c<Math.ceil(f.length/64);c++)d+=f.slice(64*c,64*c+64)+(Math.ceil(f.length/64)==c+1?"":"\n");return d},d=function(b){b=b.replace(/\n/g,"");var c,d=[],e=[],f=[];for(c=0;c<b.length;c+=4)e[0]=a.indexOf(b.charAt(c)),e[1]=a.indexOf(b.charAt(c+1)),e[2]=a.indexOf(b.charAt(c+2)),e[3]=a.indexOf(b.charAt(c+3)),f[0]=e[0]<<2|e[1]>>4,f[1]=(15&e[1])<<4|e[2]>>2,f[2]=(3&e[2])<<6|e[3],d.push(f[0],f[1],f[2]);return d=d.slice(0,d.length-d.length%16)};return"function"==typeof Array.indexOf&&(a=b),{encode:c,decode:d}}();return{size:l,h2a:j,expandKey:x,encryptBlock:q,decryptBlock:r,Decrypt:c,s2a:k,rawEncrypt:o,rawDecrypt:p,dec:O,openSSLKey:n,a2h:h,enc:N,Hash:{MD5:P},Base64:Q}}();window.PUBNUB||function(){function a(a,b){var c=CryptoJS.HmacSHA256(a,b);return c.toString(CryptoJS.enc.Base64)}function b(a){return document.getElementById(a)}function c(a){console.error(a)}function d(a,b){var c=[];return each(a.split(/\s+/),function(a){each((b||document).getElementsByTagName(a),function(a){c.push(a)})}),c}function e(a,b,c){each(a.split(","),function(a){var d=function(a){a||(a=window.event),c(a)||(a.cancelBubble=!0,a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation())};b.addEventListener?b.addEventListener(a,d,!1):b.attachEvent?b.attachEvent("on"+a,d):b["on"+a]=d})}function f(){return d("head")[0]}function g(a,b,c){return c?void a.setAttribute(b,c):a&&a.getAttribute&&a.getAttribute(b)}function h(a,b){for(var c in b)if(b.hasOwnProperty(c))try{a.style[c]=b[c]+("|width|height|top|left|".indexOf(c)>0&&"number"==typeof b[c]?"px":"")}catch(d){}}function i(a){return document.createElement(a)}function j(){return s||n()?0:unique()}function k(a){if(s||n())return l(a);var c=i("script"),d=a.callback,e=unique(),h=0,j=a.timeout||DEF_TIMEOUT,k=timeout(function(){t(1,{message:"timeout"})},j),m=a.fail||function(){},o=a.data||{},q=a.success||function(){},r=function(){f().appendChild(c)},t=function(a,d){h||(h=1,c.onerror=null,clearTimeout(k),a||!d||q(d),timeout(function(){a&&m();var c=b(e),d=c&&c.parentNode;d&&d.removeChild(c)},SECOND))};return window[d]=function(a){t(0,a)},a.blocking||(c[p]=p),c.onerror=function(){t(1)},c.src=build_url(a.url,o),g(c,"id",e),r(),t}function l(a){var b,c,d=function(){if(!f){f=1,clearTimeout(h);try{c=JSON.parse(b.responseText)}catch(a){return o(1)}e=1,l(c)}},e=0,f=0,g=a.timeout||DEF_TIMEOUT,h=timeout(function(){o(1,{message:"timeout"})},g),i=a.fail||function(){},j=a.data||{},l=a.success||function(){},m=!a.blocking,o=function(a,c){e||(e=1,clearTimeout(h),b&&(b.onerror=b.onload=null,b.abort&&b.abort(),b=null),a&&i(c))};try{b=n()||window.XDomainRequest&&new XDomainRequest||new XMLHttpRequest,b.onerror=b.onabort=function(){o(1,b.responseText||{error:"Network Connection Error"})},b.onload=b.onloadend=d,b.onreadystatechange=function(){if(b&&4==b.readyState)switch(b.status){case 401:case 402:case 403:try{c=JSON.parse(b.responseText),o(1,c)}catch(a){return o(1,b.responseText)}}},m&&(b.timeout=g);var p=build_url(a.url,j);b.open("GET",p,m),b.send()}catch(q){return o(0),s=0,k(a)}return o}function m(){return"onLine"in navigator?navigator.onLine:1}function n(){if(!y||!y.get)return 0;var a={id:n.id++,send:function(){},abort:function(){a.id={}},open:function(b,c){n[a.id]=a,y.get(a.id,c)}};return a}var o="https://pubnub.a.ssl.fastly.net/pubnub.swf",p="async",q=navigator.userAgent,r="PubNub-JS-Web/3.6.4",s=-1==q.indexOf("MSIE 6");window.console||(window.console=window.console||{}),console.log||(console.log=console.error=(window.opera||{}).postError||function(){});var t=function(){var a=window.localStorage;return{get:function(b){try{return a?a.getItem(b):-1==document.cookie.indexOf(b)?null:((document.cookie||"").match(RegExp(b+"=([^;]+)"))||[])[1]||null}catch(c){return}},set:function(b,c){try{if(a)return a.setItem(b,c)&&0;document.cookie=b+"="+c+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(d){return}}}}(),u={list:{},unbind:function(a){u.list[a]=[]},bind:function(a,b){(u.list[a]=u.list[a]||[]).push(b)},fire:function(a,b){each(u.list[a]||[],function(a){a(b)})}},v=b("pubnub")||0,w=function(l){l.jsonp&&(s=0);var n=l.subscribe_key||"",o=((+l.keepalive||DEF_KEEPALIVE)*SECOND,l.uuid||t.get(n+"uuid")||"",l.leave_on_unload||0);l.xdr=k,l.db=t,l.error=l.error||c,l._is_online=m,l.jsonp_cb=j,l.hmac_SHA256=a,l.crypto_obj=crypto_obj(),l.params={pnsdk:r};var p=function(a){return w(a)},q=PN_API(l);for(var v in q)q.hasOwnProperty(v)&&(p[v]=q[v]);return p.css=h,p.$=b,p.create=i,p.bind=e,p.head=f,p.search=d,p.attr=g,p.events=u,p.init=p,p.secure=p,e("beforeunload",window,function(){return o&&p["each-channel"](function(a){p.LEAVE(a.name,0)}),!0}),l.notest?p:(e("offline",window,p.offline),e("offline",document,p.offline),p)};w.init=w,w.secure=w,"complete"===document.readyState?timeout(ready,0):e("load",window,function(){timeout(ready,0)});var x=v||{};PUBNUB=w({notest:1,publish_key:g(x,"pub-key"),subscribe_key:g(x,"sub-key"),ssl:!document.location.href.indexOf("https")||"on"==g(x,"ssl"),origin:g(x,"origin"),uuid:g(x,"uuid")}),window.jQuery&&(window.jQuery.PUBNUB=w),"undefined"!=typeof module&&(module.exports=PUBNUB)&&ready();
var y=b("pubnubs")||0;v&&(h(v,{position:"absolute",top:-SECOND}),("opera"in window||g(v,"flash"))&&(v.innerHTML="<object id=pubnubs data="+o+"><param name=movie value="+o+"><param name=allowscriptaccess value=always></object>"),PUBNUB.rdx=function(a,b){return b?(n[a].responseText=unescape(b),void n[a].onload()):n[a].onerror()},n.id=SECOND)}(),function(){var a=PUBNUB.ws=function(b,c){if(!(this instanceof a))return new a(b,c);var d=this,b=d.url=b||"",e=(d.protocol=c||"Sec-WebSocket-Protocol",b.split("/")),f={ssl:"wss:"===e[0],origin:e[2],publish_key:e[3],subscribe_key:e[4],channel:e[5]};return d.CONNECTING=0,d.OPEN=1,d.CLOSING=2,d.CLOSED=3,d.CLOSE_NORMAL=1e3,d.CLOSE_GOING_AWAY=1001,d.CLOSE_PROTOCOL_ERROR=1002,d.CLOSE_UNSUPPORTED=1003,d.CLOSE_TOO_LARGE=1004,d.CLOSE_NO_STATUS=1005,d.CLOSE_ABNORMAL=1006,d.onclose=d.onerror=d.onmessage=d.onopen=d.onsend=function(){},d.binaryType="",d.extensions="",d.bufferedAmount=0,d.trasnmitting=!1,d.buffer=[],d.readyState=d.CONNECTING,b?(d.pubnub=PUBNUB.init(f),d.pubnub.setup=f,d.setup=f,void d.pubnub.subscribe({restore:!1,channel:f.channel,disconnect:d.onerror,reconnect:d.onopen,error:function(){d.onclose({code:d.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:!1})},callback:function(a){d.onmessage({data:a})},connect:function(){d.readyState=d.OPEN,d.onopen()}})):(d.readyState=d.CLOSED,d.onclose({code:d.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:!0}),d)};a.prototype.send=function(a){var b=this;b.pubnub.publish({channel:b.pubnub.setup.channel,message:a,callback:function(a){b.onsend({data:a})}})},a.prototype.close=function(){var a=this;a.pubnub.unsubscribe({channel:a.pubnub.setup.channel}),a.readyState=a.CLOSED,a.onclose({})}}(),!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.SinchClient=a()}}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(){}var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){var d=c.shift();d()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.on=c,d.addListener=c,d.once=c,d.off=c,d.removeListener=c,d.removeAllListeners=c,d.emit=c,d.binding=function(){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(){throw new Error("process.chdir is not supported")}},{}],2:[function(b,c,d){(function(b){!function(b){if("function"==typeof bootstrap)bootstrap("promise",b);else if("object"==typeof d)c.exports=b();else if("function"==typeof a&&a.amd)a(b);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=b}else Q=b()}(function(){"use strict";function a(a){return function(){return W.apply(a,arguments)}}function c(a){return a===Object(a)}function d(a){return"[object StopIteration]"===cb(a)||a instanceof S}function e(a,b){if(P&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(db)){for(var c=[],d=b;d;d=d.source)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var e=c.join("\n"+db+"\n");a.stack=f(e)}}function f(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];i(e)||g(e)||!e||c.push(e)}return c.join("\n")}function g(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function h(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function i(a){var b=h(a);if(!b)return!1;var c=b[0],d=b[1];return c===R&&d>=T&&hb>=d}function j(){if(P)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=h(c);if(!d)return;return R=d[0],d[1]}}function k(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack),a.apply(a,arguments)}}function l(a){return s(a)?a:t(a)?C(a):B(a)}function m(){function a(a){b=a,f.source=a,Y(c,function(b,c){V(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=_(m.prototype),f=_(p.prototype);if(f.promiseDispatch=function(a,e,f){var g=X(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):V(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=r(b);return s(a)&&(b=a),a},f.inspect=function(){return b?b.inspect():{state:"pending"}},l.longStackSupport&&P)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(l(c))},e.fulfill=function(c){b||a(B(c))},e.reject=function(c){b||a(A(c))},e.notify=function(a){b||Y(d,function(b,c){V(function(){c(a)})},void 0)},e}function n(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=m();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function o(a){return n(function(b,c){for(var d=0,e=a.length;e>d;d++)l(a[d]).then(b,c)})}function p(a,b,c){void 0===b&&(b=function(a){return A(new Error("Promise does not support operation: "+a))}),void 0===c&&(c=function(){return{state:"unknown"}});var d=_(p.prototype);if(d.promiseDispatch=function(c,e,f){var g;try{g=a[e]?a[e].apply(d,f):b.call(d,e,f)}catch(h){g=A(h)}c&&c(g)},d.inspect=c,c){var e=c();"rejected"===e.state&&(d.exception=e.reason),d.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value}}return d}function q(a,b,c,d){return l(a).then(b,c,d)}function r(a){if(s(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function s(a){return c(a)&&"function"==typeof a.promiseDispatch&&"function"==typeof a.inspect}function t(a){return c(a)&&"function"==typeof a.then}function u(a){return s(a)&&"pending"===a.inspect().state}function v(a){return!s(a)||"fulfilled"===a.inspect().state}function w(a){return s(a)&&"rejected"===a.inspect().state}function x(){eb.length=0,fb.length=0,gb||(gb=!0)}function y(a,b){gb&&(fb.push(a),eb.push(b&&"undefined"!=typeof b.stack?b.stack:"(no stack) "+b))}function z(a){if(gb){var b=Z(fb,a);-1!==b&&(fb.splice(b,1),eb.splice(b,1))}}function A(a){var b=p({when:function(b){return b&&z(this),b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});return y(b,a),b}function B(a){return p({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return bb(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function C(a){var b=m();return V(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function D(a){return p({isDef:function(){}},function(b,c){return J(a,b,c)},function(){return l(a).inspect()})}function E(a,b,c){return l(a).spread(b,c)}function F(a){return function(){function b(a,b){var g;if("undefined"==typeof StopIteration){try{g=c[a](b)}catch(h){return A(h)}return g.done?g.value:q(g.value,e,f)}try{g=c[a](b)}catch(h){return d(h)?h.value:A(h)}return q(g,e,f)}var c=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}}function G(a){l.done(l.async(a)())}function H(a){throw new S(a)}function I(a){return function(){return E([this,K(arguments)],function(b,c){return a.apply(b,c)})}}function J(a,b,c){return l(a).dispatch(b,c)}function K(a){return q(a,function(a){var b=0,c=m();return Y(a,function(d,e,f){var g;s(e)&&"fulfilled"===(g=e.inspect()).state?a[f]=g.value:(++b,q(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0),0===b&&c.resolve(a),c.promise})}function L(a){return q(a,function(a){return a=$(a,l),q(K($(a,function(a){return q(a,U,U)})),function(){return a})})}function M(a){return l(a).allSettled()}function N(a,b){return l(a).then(void 0,void 0,b)}function O(a,b){return l(a).nodeify(b)}var P=!1;try{throw new Error}catch(Q){P=!!Q.stack}var R,S,T=j(),U=function(){},V=function(){function a(){for(;c.next;){c=c.next;var b=c.task;c.task=void 0;var d=c.domain;d&&(c.domain=void 0,d.enter());try{b()}catch(f){if(g)throw d&&d.exit(),setTimeout(a,0),d&&d.enter(),f;setTimeout(function(){throw f},0)}d&&d.exit()}e=!1}var c={task:void 0,next:null},d=c,e=!1,f=void 0,g=!1;if(V=function(a){d=d.next={task:a,domain:g&&b.domain,next:null},e||(e=!0,f())},"undefined"!=typeof b&&b.nextTick)g=!0,f=function(){b.nextTick(a)};else if("function"==typeof setImmediate)f="undefined"!=typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!=typeof MessageChannel){var h=new MessageChannel;h.port1.onmessage=function(){f=i,h.port1.onmessage=a,a()};var i=function(){h.port2.postMessage(0)};f=function(){setTimeout(a,0),i()}}else f=function(){setTimeout(a,0)};return V}(),W=Function.call,X=a(Array.prototype.slice),Y=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),Z=a(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),$=a(Array.prototype.map||function(a,b){var c=this,d=[];return Y(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),_=Object.create||function(a){function b(){}return b.prototype=a,new b},ab=a(Object.prototype.hasOwnProperty),bb=Object.keys||function(a){var b=[];for(var c in a)ab(a,c)&&b.push(c);return b},cb=a(Object.prototype.toString);S="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var db="From previous event:";l.resolve=l,l.nextTick=V,l.longStackSupport=!1,l.defer=m,m.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):a.resolve(arguments.length>2?X(arguments,1):c)}},l.Promise=n,l.promise=n,n.race=o,n.all=K,n.reject=A,n.resolve=l,l.passByCopy=function(a){return a},p.prototype.passByCopy=function(){return this},l.join=function(a,b){return l(a).join(b)},p.prototype.join=function(a){return l([this,a]).spread(function(a,b){if(a===b)return a;throw new Error("Can't join: not the same: "+a+" "+b)})},l.race=o,p.prototype.race=function(){return this.then(l.race)},l.makePromise=p,p.prototype.toString=function(){return"[object Promise]"},p.prototype.then=function(a,b,c){function d(b){try{return"function"==typeof a?a(b):b}catch(c){return A(c)}}function f(a){if("function"==typeof b){e(a,h);try{return b(a)}catch(c){return A(c)}}return A(a)}function g(a){return"function"==typeof c?c(a):a}var h=this,i=m(),j=!1;return V(function(){h.promiseDispatch(function(a){j||(j=!0,i.resolve(d(a)))},"when",[function(a){j||(j=!0,i.resolve(f(a)))}])}),h.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=g(a)}catch(d){if(c=!0,!l.onerror)throw d;l.onerror(d)}c||i.notify(b)}]),i.promise},l.when=q,p.prototype.thenResolve=function(a){return this.then(function(){return a})},l.thenResolve=function(a,b){return l(a).thenResolve(b)},p.prototype.thenReject=function(a){return this.then(function(){throw a})},l.thenReject=function(a,b){return l(a).thenReject(b)},l.nearer=r,l.isPromise=s,l.isPromiseAlike=t,l.isPending=u,p.prototype.isPending=function(){return"pending"===this.inspect().state},l.isFulfilled=v,p.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},l.isRejected=w,p.prototype.isRejected=function(){return"rejected"===this.inspect().state};var eb=[],fb=[],gb=!0;l.resetUnhandledRejections=x,l.getUnhandledReasons=function(){return eb.slice()},l.stopUnhandledRejectionTracking=function(){x(),gb=!1},x(),l.reject=A,l.fulfill=B,l.master=D,l.spread=E,p.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)},l.async=F,l.spawn=G,l["return"]=H,l.promised=I,l.dispatch=J,p.prototype.dispatch=function(a,b){var c=this,d=m();return V(function(){c.promiseDispatch(d.resolve,a,b)}),d.promise},l.get=function(a,b){return l(a).dispatch("get",[b])},p.prototype.get=function(a){return this.dispatch("get",[a])},l.set=function(a,b,c){return l(a).dispatch("set",[b,c])},p.prototype.set=function(a,b){return this.dispatch("set",[a,b])},l.del=l["delete"]=function(a,b){return l(a).dispatch("delete",[b])},p.prototype.del=p.prototype["delete"]=function(a){return this.dispatch("delete",[a])},l.mapply=l.post=function(a,b,c){return l(a).dispatch("post",[b,c])},p.prototype.mapply=p.prototype.post=function(a,b){return this.dispatch("post",[a,b])},l.send=l.mcall=l.invoke=function(a,b){return l(a).dispatch("post",[b,X(arguments,2)])},p.prototype.send=p.prototype.mcall=p.prototype.invoke=function(a){return this.dispatch("post",[a,X(arguments,1)])},l.fapply=function(a,b){return l(a).dispatch("apply",[void 0,b])},p.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])},l["try"]=l.fcall=function(a){return l(a).dispatch("apply",[void 0,X(arguments,1)])},p.prototype.fcall=function(){return this.dispatch("apply",[void 0,X(arguments)])},l.fbind=function(a){var b=l(a),c=X(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(X(arguments))])}},p.prototype.fbind=function(){var a=this,b=X(arguments);return function(){return a.dispatch("apply",[this,b.concat(X(arguments))])}},l.keys=function(a){return l(a).dispatch("keys",[])},p.prototype.keys=function(){return this.dispatch("keys",[])},l.all=K,p.prototype.all=function(){return K(this)},l.allResolved=k(L,"allResolved","allSettled"),p.prototype.allResolved=function(){return L(this)},l.allSettled=M,p.prototype.allSettled=function(){return this.then(function(a){return K($(a,function(a){function b(){return a.inspect()}return a=l(a),a.then(b,b)}))})},l.fail=l["catch"]=function(a,b){return l(a).then(void 0,b)},p.prototype.fail=p.prototype["catch"]=function(a){return this.then(void 0,a)},l.progress=N,p.prototype.progress=function(a){return this.then(void 0,void 0,a)},l.fin=l["finally"]=function(a,b){return l(a)["finally"](b)},p.prototype.fin=p.prototype["finally"]=function(a){return a=l(a),this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b})})},l.done=function(a,b,c,d){return l(a).done(b,c,d)},p.prototype.done=function(a,c,d){var f=function(a){V(function(){if(e(a,g),!l.onerror)throw a;l.onerror(a)})},g=a||c||d?this.then(a,c,d):this;"object"==typeof b&&b&&b.domain&&(f=b.domain.bind(f)),g.then(void 0,f)},l.timeout=function(a,b,c){return l(a).timeout(b,c)},p.prototype.timeout=function(a,b){var c=m(),d=setTimeout(function(){c.reject(new Error(b||"Timed out after "+a+" ms"))},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)},c.notify),c.promise},l.delay=function(a,b){return void 0===b&&(b=a,a=void 0),l(a).delay(b)},p.prototype.delay=function(a){return this.then(function(b){var c=m();return setTimeout(function(){c.resolve(b)},a),c.promise})},l.nfapply=function(a,b){return l(a).nfapply(b)},p.prototype.nfapply=function(a){var b=m(),c=X(a);return c.push(b.makeNodeResolver()),this.fapply(c).fail(b.reject),b.promise},l.nfcall=function(a){var b=X(arguments,1);return l(a).nfapply(b)},p.prototype.nfcall=function(){var a=X(arguments),b=m();return a.push(b.makeNodeResolver()),this.fapply(a).fail(b.reject),b.promise},l.nfbind=l.denodeify=function(a){var b=X(arguments,1);return function(){var c=b.concat(X(arguments)),d=m();return c.push(d.makeNodeResolver()),l(a).fapply(c).fail(d.reject),d.promise}},p.prototype.nfbind=p.prototype.denodeify=function(){var a=X(arguments);return a.unshift(this),l.denodeify.apply(void 0,a)},l.nbind=function(a,b){var c=X(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(X(arguments)),f=m();return e.push(f.makeNodeResolver()),l(d).fapply(e).fail(f.reject),f.promise}},p.prototype.nbind=function(){var a=X(arguments,0);return a.unshift(this),l.nbind.apply(void 0,a)},l.nmapply=l.npost=function(a,b,c){return l(a).npost(b,c)},p.prototype.nmapply=p.prototype.npost=function(a,b){var c=X(b||[]),d=m();return c.push(d.makeNodeResolver()),this.dispatch("post",[a,c]).fail(d.reject),d.promise},l.nsend=l.nmcall=l.ninvoke=function(a,b){var c=X(arguments,2),d=m();return c.push(d.makeNodeResolver()),l(a).dispatch("post",[b,c]).fail(d.reject),d.promise},p.prototype.nsend=p.prototype.nmcall=p.prototype.ninvoke=function(a){var b=X(arguments,1),c=m();return b.push(c.makeNodeResolver()),this.dispatch("post",[a,b]).fail(c.reject),c.promise},l.nodeify=O,p.prototype.nodeify=function(a){return a?void this.then(function(b){V(function(){a(null,b)})},function(b){V(function(){a(b)})}):this};var hb=j();return l})}).call(this,b("_process"))},{_process:1}],3:[function(a,b){function Notification(a,b,c,d){this.progress=a/b,this.message=c,this.object=d}function c(a){if(!a)throw new TypeError("Could not create SinchClient, configuration not provided.");if(!(a.capabilities instanceof Object))throw new TypeError("Could not create SinchClient, capabilities is not an object");if("string"!=typeof a.applicationKey)throw new TypeError("Could not create SinchClient, applicationKey is not a string");var b=!1;for(B in a.capabilities)b|=a.capabilities[B];if(!b)throw new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"No capability requested");this.capabilities=a.capabilities,this._appKey=a.applicationKey||"",this._sessionId="",this._sessionSecret="",this._logHandler=a.onLogMessage||function(){},this._logMxpHandler=a.onLogMxpMessage||function(){},this.applicationKey=this._appKey,this._url={base:"https://api.sinch.com/v1/",user:"https://userapi.sinch.com/v1/",portal:"https://portalapi.sinch.com/v1/",reporting:"https://reportingapi.sinch.com/v1/",calling:"https://callingapi.sinch.com/v1/",messaging:"https://messagingapi.sinch.com/v1/",MTU:"",social:"",payment:""},this.loadPAPIUrl(),this.loadTimeDelta(),this.user=new i(this),"messaging"in this.capabilities&&this.capabilities.messaging&&(this.messageClient=new h(this)),"calling"in this.capabilities&&this.capabilities.calling&&(this.callClient=new e(this))}function d(a,b){this.sinch=a,this.eventListeners=[],this.callId=b||r(),this.callDomain="None",this.callOutbound=void 0,this.fromId="",this.toId="",this.webRtcConfig={iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}]},this.outgoingStream=void 0,this.outgoingStreamURL=void 0,this.incomingStream=void 0,this.incomingStreamURL=void 0,this.callState=w.INITIATING,this.callEndCause=void 0,this.timeProgressing=void 0,this.timeEstablished=void 0,this.timeEnded=void 0,this.error=void 0,this.clientMap={},this.sdpMap={},this.iceMapRx={},this.activeInstance=void 0,this.pcMap={};var c={onCallEnded:function(a){var b=a.getDetails();if(b.startedTime){var c={callId:a.callId,domain:a.callDomain,outbound:a.callOutbound,fromId:a.fromId,toId:a.toId,callTime:new Date(b.startedTime).toISOString(),duration:b.duration,setupDuration:(a.timeEstablished-a.timeProgressing)/1e3||0,result:a.callEndCause};a.sinch.callReporting(c).fail(function(){console.error("Could not report call!")})}}};this.addEventListener(c)}function e(a,b){if(!(a instanceof c))throw new Error("CallClient can't be instantiated, use getCallClient in an SinchClient instance");var d=navigator.userAgent.toLowerCase();if(d.indexOf("msie")>-1||/Apple Computer/.test(navigator.vendor))throw new Error("SinchClient can't be started with calling capability. Browser not supported.");this.sinch=a,this.eventListeners=[],this.callBuffert={},this.localMediaStream=void 0,this.incomingCallCustomStream=b}function f(a){if(this.delivered=[],a instanceof k){this.messageId=a.mxpSessionId;var b=JSON.parse(a.decrypted.bd);this.textBody=b.t,this.recipientIds=a.recipientIds,this.senderId=a.decrypted.fu;try{"object"==typeof a.decrypted.nvps.ph&&(this.headers=a.decrypted.nvps.ph)}catch(c){}this.timestamp=(new Date).getTime()}else{if(!(a instanceof Object))throw new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Unsupported message parameters",a);this.messageId=r(),this.recipientIds=a.recipientIds,this.textBody=a.textBody,this.senderId=a.senderId,this.headers=a.publicHeaders,this.timestamp=(new Date).getTime()}}function g(a,b){this.messageId=b,this.recipientId=a,this.timestamp=(new Date).getTime()}function h(a){if(!(a instanceof c))throw new Error("MessageClient can't be instantiated, use getMessageClient in an SinchClient instance");this.sinch=a,this.eventListeners=[],this.messageBuffert={},this.ackBuffert={},this.onMessageDelivered=[]}function SinchError(a,b,c,d){this.name="SinchError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General sinch error",this.stack=new Error(c).stack}function i(a){this.userObj={},this.sinch=a}function j(a){this.sinch=a,this.user=a.user,this.rtcConfiguration=a.user.mxpConfig.rtcConfiguration,this.rtcProfile=a.user.mxpConfig.rtcProfile,this.broadcastPubNub=PUBNUB({publish_key:this.rtcConfiguration.broadcastNetwork.publishKey,subscribe_key:this.rtcConfiguration.broadcastNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.broadcastNetwork.host}),this.signalPubNub=PUBNUB({publish_key:this.rtcConfiguration.signalNetwork.publishKey,subscribe_key:this.rtcConfiguration.signalNetwork.subscribeKey,ssl:!0,origin:this.rtcConfiguration.signalNetwork.host}),this.messageBuffert={},this.transportBuffert={},this.sessionBuffert={}}function MXPError(a,b,c,d){this.name="MXPError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General MXP error",this.stack=new Error(c).stack}function MXPLog(a,b){this.message=a,this.object=b}function MXPIncoming(a,b){this.handler=a,this.object=b}function MXPOutgoing(a,b){this.handler=a,this.object=b}function k(a,b){this.decrypted={};for(var c in a)if("object"==typeof a[c]){this[c]=a[c]instanceof Array?[]:{};for(var e in a[c])this[c][e]=a[c][e]}else this[c]=a[c];if(b instanceof d){b.activeInstance&&(this.decrypted.nvps=this.decrypted.nvps||{},this.decrypted.nvps.to=b.activeInstance),this.txChannels=[];for(var f in b.clientMap)-1===this.txChannels.indexOf(b.clientMap[f].fs)&&this.txChannels.push(b.clientMap[f].fs);this.sub="signalPubNub"}}function l(a,b,c,d){this.name="MXPError",this.domain=a||-1,this.code=b||0,this.response=d||{},this.message=c||"General MXP error",this.stack=new Error(c).stack}var m=a("q"),n={ErrorDomainNone:-1,ErrorDomainNetwork:0,ErrorDomainCapability:1,ErrorDomainSession:2,ErrorDomainApi:3,ErrorDomainOther:4,ErrorDomainSDK:5},o={NoneNone:0,NetworkConnectionRefused:1e3,NetworkConnectionTimedOut:1001,NetworkServerError:1002,CapabilityUserNotFound:2e3,CapabilityCapabilityMissing:2001,CapabilityAuthenticationFailed:2002,SessionFailedToInitiateSession:3e3,SessionNoPendingSessionExists:3001,SessionTransferCantBeInitiated:3002,SessionActiveUserLimitReached:3003,ApiApiCallFailed:4e3,OtherInvalidOfflinePayloadTooBig:5e3,OtherInvalidOfflineInvitePayloadFailedToDecode:5001,OtherInvalidOfflineInviteUnknownType:5002,OtherOther:5003,SDKUnexpectedCall:6e3,SDKInternalError:6001,SDKInternalOther:6002,SDKMissingParameter:6003,SDKMissingCallback:6004},p=function(a){var b=m.defer(),c=new XMLHttpRequest;c.onload=function(){if(c.status>=200&&c.status<300){try{c.response=c.response||c.responseText,c.data=JSON.parse(c.response||"{}")}catch(a){console.log("Cant parse JSON"+c.response)}b.resolve(c.data)}else{try{c.response=c.response||c.responseText,c.data=JSON.parse(c.response||"{}")}catch(a){console.log("Cant parse JSON"+c.response)}b.reject(c)}},c.onerror=function(){b.reject(new Error("Unsupported operation "+c.status,c))},c.open(a.method,a.url,!0);for(var d in a.headers)c.setRequestHeader(d,a.headers[d]);return c.send(JSON.stringify(a.data)),b.promise},q=function(a,b){var c={method:a.method,headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json, text/plain, */*"}};"GET"!=a.method&&(c.data=b),c.url="";for(var d in a.urlParts){if(":"===a.urlParts[d][0]){var e=a.urlParts[d].slice(1);c.url+=(b||{})[e]}else c.url+=a.urlParts[d];d<a.urlParts.length-1&&(c.url+="/")}switch(a.auth){case"sign":c.headers=this.signSession(c);break;case"nosign":c.headers=this.signApp(c);break;case"ticket":c.headers=this.signTicket(c),delete c.data.authorization;break;case"signorticket":this._sessionId?c.headers=this.signSession(c):(c.headers=this.signTicket(c),delete c.data.authorization);break;default:throw new Error("Unsupported authentication type: "+a.auth)}if("GET"===a.method&&b&&Object.keys(b).length>0){c.url+="?";for(var f in b)c.url+=encodeURIComponent(f)+"="+encodeURIComponent(b[f])+"&"}return p(c)},r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},s=s||{};s.base={getServerTime:{url:"timestamp/",method:"GET",auth:"nosign"},getInstance:{url:"instance",method:"POST",auth:"ticket"}};var s=s||{};s.calling={getConfiguration:{url:"configuration/user",method:"GET",auth:"sign"},PSTNCall:{url:"calls/pstn",method:"POST",auth:"sign"},callData:{url:"calls/data",method:"POST",auth:"sign"},callReporting:{url:"calls/:domain/id/:callId",method:"PUT",auth:"sign"}};var s=s||{};s.messaging={getTransportById:{url:"transport",method:"GET",auth:"sign"},getTransportByParticipants:{url:"transport",method:"POST",auth:"sign"}};var s=s||{};s.user={authenticate:{url:"users/email/:email/authentication",method:"POST",auth:"nosign"},authenticateUsername:{url:"users/username/:username/authentication",method:"POST",auth:"nosign"},authenticateNumber:{url:"users/number/:number/authentication",method:"POST",auth:"nosign"},createUser:{url:"users",method:"POST",auth:"nosign"},changePassword:{url:"user/password",method:"PUT",auth:"sign"},updateUser:{url:"user/profile",method:"PATCH",auth:"sign"},getUserProfile:{url:"user/profile",method:"GET",auth:"sign"}},c.prototype.loadPAPIUrl=function(){this.PAPI=JSON.parse(JSON.stringify(s));for(var a in s)for(var b in s[a])this.PAPI[a][b].urlParts=(this._url[a]+this.PAPI[a][b].url).split("/"),this[b]=q.bind(this,this.PAPI[a][b])},c.prototype.loadTimeDelta=function(){var a=m.defer();return this.timeDelta?a.resolve():this.getServerTime().then(function(b){var c=new Date(b.timestamp),d=new Date;this.timeDelta=c-d,a.resolve()}.bind(this)).catch(function(b){console.error(b),a.fail(b)}),a.promise},c.prototype.config=function(a){this._appKey=a.appKey||this._appKey,this._sessionId=a.sessionId||this._sessionId,this._sessionSecret=a.sessionSecret||this._sessionSecret},c.prototype.log=function(a,b){b&&b.notify(a),this._logHandler(a)},c.prototype.logMxp=function(a){this._logMxpHandler(a)},c.prototype.setUrl=function(a){this._url.user=a.user||this._url.user,this._url.base=a.base||this._url.base,this._url.portal=a.portal||this._url.portal,this._url.reporting=a.reporting||this._url.reporting,this._url.calling=a.calling||this._url.calling,this._url.messaging=a.messaging||this._url.messaging,this.loadPAPIUrl()},c.prototype.stop=function(){this.mxp.close(),delete this.mxp,this._sessionId="",this._sessionSecret=""},c.prototype.adjustedTime=function(){var a=(new Date).getTime();return new Date(a+this.timeDelta||0).toISOString()},c.prototype.signSession=function(a){try{var b="";if(void 0!==a.data){var c="string"!=typeof a.data?JSON.stringify(a.data):a.data;b=G.MD5(c).toString(G.enc.Base64)}a.headers["Content-Type"]=(a.headers["Content-Type"]||"").replace("utf-8","UTF-8").replace("/json;chars","/json; chars"),a.headers["X-Timestamp"]=a.headers["X-Timestamp"]||this.adjustedTime();var d=""+a.method+"\n"+b+"\n"+(a.headers["Content-Type"]||"")+"\nx-timestamp:"+a.headers["X-Timestamp"]+"\n"+a.url.match(/^https?:\/\/[^\/]+([^#]*)/)[1];if(this._sessionId.length>0&&this._sessionSecret.length>0){var e=G.HmacSHA256(G.enc.Utf8.parse(d),G.enc.Base64.parse(this._sessionSecret)).toString(G.enc.Base64);a.headers.Authorization="instance "+this._sessionId+":"+e}else a.headers.Authorization="application "+this._appKey;return a.headers}catch(f){throw f}return null},c.prototype.signTicket=function(a,b){return b=b||a.data.authorization,a.headers=a.headers||{},a.headers.Authorization="user "+b,a.headers["X-Timestamp"]=this.adjustedTime(),a.headers},c.prototype.signApp=function(a){try{return a.headers["X-Timestamp"]=a.headers["X-Timestamp"]||this.adjustedTime(),a.headers.Authorization="application "+this._appKey,a.headers}catch(b){throw b}return null},c.prototype.getSession=function(){return{userId:this.user.userId,sessionId:this._sessionId,sessionSecret:this._sessionSecret}},c.prototype.newUser=function(a,b,c){var d=m.defer();return b=b||function(a){return console.info("User successfully created"),a},c=c||function(a){console.error(a)},this.user.create(a).then(b).then(d.resolve).fail(function(a){this.log(a),c(a),d.reject(a)}.bind(this)),d.promise},c.prototype.start=function(a,b,c){var d=m.defer();if(b=b||function(){console.info("Sinch client started")},c=c||function(a){console.error(a)},this.started){var e=new Error("Sinch client already started");c(e),d.reject(e)}else this.started=!0,this.loadTimeDelta().then(function(a){return this.log(new Notification(0,5,"Get authentication token"),d),this.user.authenticate(a)}.bind(this,a),a).then(function(a){return this.log(new Notification(1,5,"Get instance using auth token"),d),a&&a.sessionId&&a.sessionSecret?this.user.resumeSession(a):this.user.initSessKeySecret()}.bind(this)).then(function(){return this.log(new Notification(2,5,"Get MXP configuration"),d),this.user.getMXPConf()}.bind(this)).then(function(){this.log(new Notification(3,5,"Create MXP object"),d),this.mxp=new j(this)}.bind(this)).then(function(){return this.log(new Notification(4,5,"Initiate MXP"),d),this.mxp.init()}.bind(this)).then(b).then(function(){this.log(new Notification(5,5,"Successfully started SinchClient"),d),d.resolve(this)}.bind(this)).fail(function(a){this.started=!1,this.log(a),c(a),d.reject(a)}.bind(this));return d.promise},c.prototype.getMessageClient=function(){if("messaging"in this.capabilities&&this.capabilities.messaging)return this.messageClient;throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"No messaging capability, not possible to retrieve messageClient")},c.prototype.getCallClient=function(){if("calling"in this.capabilities&&this.capabilities.calling)return this.callClient;throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"No calling capability, not possible to retrieve callClient")};var t,u,v;t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection||WRTC.RTCPeerConnection,u=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription||WRTC.RTCSessionDescription,v=window.mozRTCIceCandidate||window.RTCIceCandidate||WRTC.RTCIceCandidate,d.prototype.addEventListener=function(a){this.eventListeners.push(a)},d.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},d.prototype.setStream=function(a){this.outgoingStream=a,this.outgoingStreamURL=window.URL.createObjectURL(a)},d.prototype.execListener=function(a){this.eventListeners.forEach(function(b){try{return b[a]&&b[a](this)}catch(c){var d=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error executing listener: "+a,c);throw console.error(d),d
}}.bind(this))},d.prototype.setEndCause=function(a){void 0===this.callEndCause&&(this.callEndCause=a)},d.prototype.setParticipants=function(a,b){this.callOutbound=a==this.sinch.user.userId,this.toId=b,this.fromId=a},d.prototype.progress=function(){if(this.callState!=w.INITIATING)throw new SinchError(n.ErrorDomainOther,o.OtherOther,"Progress: Invalid call state for progressing",d);this.sinch.log(new Notification(0,1,"Call changing state to PROGRESSING")),this.timeProgressing=Date.now(),this.callState=w.PROGRESSING},d.prototype.establish=function(){if(this.callState==w.PROGRESSING){this.sinch.log(new Notification(0,1,"Call changing state to ESTABLISHED")),this.pc=this.pc||this.pcMap[this.activeInstance];for(var a in this.pcMap)a!=this.activeInstance&&(this.pcMap[a]&&"closed"!=this.pcMap[a].signalingState&&this.pcMap[a].close(),delete this.pcMap[a]);this.incomingStream=this.pc.getRemoteStreams()[0],this.incomingStreamURL=window.URL.createObjectURL(this.incomingStream),this.timeEstablished=Date.now(),this.callState=w.ESTABLISHED,this.execListener("onCallEstablished")}else console.log("Call state not in PROGRESSING, cant process second JOIN")},d.prototype.mxpAck=function(a){if(this.sinch.log(new Notification(0,1,"Call ACK Received",a)),this.callState!=w.INITIATING&&this.callState!=w.PROGRESSING)throw new SinchError(n.ErrorDomainOther,o.OtherOther,"Invalid call state for processing Ack",d);this.callState==w.INITIATING&&(this.progress(),this.execListener("yes"===(a.decrypted.nvps||{}).earlymedia?"onCallEstablished":"onCallProgressing"));var b=a.decrypted.fi;this.clientMap[b]={fc:a.decrypted.fc,fd:a.decrypted.fd,fi:a.decrypted.fi,fs:a.decrypted.fs,fu:a.decrypted.fu}},d.prototype.mxpAckWithSdp=function(a){this.callState==w.INITIATING||this.callState==w.PROGRESSING?(this.mxpSdpOffer(a),this.mxpAck(a)):this.sinch.mxp.callCancel(this,a.decrypted.fi).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Cancel")})},d.prototype.mxpSdpOffer=function(a){if(this.callState!=w.ENDED){var b=JSON.parse(a.decrypted.bd);this.sinch.log(new Notification(0,3,"Received a SDP offer from B",b));var c=new u(b),d=this.initPC();this.pcMap[a.decrypted.fi]=d,d.setRemoteDescription(c,function(){for(this.sinch.log(new Notification(1,3,"Successfully configured SDP Offer.",b));(this.iceMapRx[this.activeInstance]||[]).length;){var c=this.iceMapRx[this.activeInstance].pop();d.addIceCandidate(new v(c))}d.createAnswer(function(b){d.setLocalDescription(b,function(){this.sinch.log(new Notification(2,3,"Successfully created SDP Answer.",b)),this.sinch.mxp.sendSdpAnswer(this,b,a.decrypted.fi).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending SDP Answer")})}.bind(this),function(a){console.log("Major error in setting local description",a)})}.bind(this),function(a){console.error("Major error in creating answer",a)})}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(x.FAILURE),this.error=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,a),this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error setting remote SDP")}.bind(this))}},d.prototype.mxpInjectIce=function(a){if(this.callState!=w.ENDED){this.sinch.log(new Notification(0,2,"Recieved ICE Candidate offer from B",b));var b=JSON.parse(a.decrypted.bd);b.candidate=b.cand,b.sdpMLineIndex=b.sdpMLI;var c=a.decrypted.fi;c in this.pcMap?(this.sinch.log(new Notification(0,2,"Injecting ICE candidate directly",b)),this.pcMap[c].addIceCandidate(new v(b))):(this.sinch.log(new Notification(0,2,"Buffering ICE candidate until PeerConnection created",b)),this.iceMapRx[c]=this.iceMapRx[a.decrypted.fi]||[],this.iceMapRx[c].push(b))}},d.prototype.mxpSdpAnswer=function(a){if(this.callState!=w.ENDED){var b=JSON.parse(a.decrypted.bd);this.sinch.log(new Notification(0,2,"Recieved SDP answer from B",b));var c=this.pcMap[a.decrypted.fi],d=new u(b);c.setRemoteDescription(d,function(){this.sinch.log(new Notification(1,2,"Successfully configured SDP Answer.",b))}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(x.FAILURE),this.error=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,a),this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Cancel")}),this.callFailure()}.bind(this),2e3),new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error setting remote SDP")}.bind(this))}},d.prototype.mxpJoin=function(a){if(this.sinch.log(new Notification(0,1,"Call JOIN Received",a)),this.activeInstance)throw console.error("Can not process JOIN, call in session after previous JOIN"),new SinchError(n.ErrorDomainSession,o.SessionActiveUserLimitReached,"Can not process JOIN, call in session after previous JOIN");if(this.callState!=w.PROGRESSING)throw console.error("Can not process JOIN, call in unexpected state. Call state: "+this.getState()),new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Can not process JOIN, call in unexpected state.");this.activeInstance=a.decrypted.fi,this.sinch.mxp.callJoined(this).then(function(){this.establish()}.bind(this)).fail(function(a){console.error("Unhandled error in call.mxpJoin.",a)})},d.prototype.mxpJoined=function(a){if(this.sinch.log(new Notification(0,1,"Call JOINED Received",a)),this.callState==w.INITIATING||this.callState==w.PROGRESSING){var b=JSON.parse(a.decrypted.bd);b.fi!=this.sinch._sessionId?(this.setEndCause(x.OTHER_DEVICE_ANSWERED),this.mxpHangup()):this.callState==w.PROGRESSING&&this.establish()}else console.log("Call state already ESTABLISHED (or ENDED), cant process second JOIN")},d.prototype.mxpHangup=function(a){if(this.callState!=w.ENDED){this.sinch.log(new Notification(0,1,"Call HANGUP Received",a)),this.setEndCause("ESTABLISHED"==this.getState()?x.HUNG_UP:x.CANCELED),this.timeEnded=Date.now(),this.callState=w.ENDED,this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var b in this.pcMap)delete this.pcMap[b]}},d.prototype.mxpDeny=function(a){if(this.callState!=w.ENDED){this.sinch.log(new Notification(0,1,"Call DENIED Received",a)),this.timeEnded=Date.now(),this.callState=w.ENDED;var b=Date.now();this.setEndCause(b-this.timeProgressing>4e4?x.NO_ANSWER:x.DENIED),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var c in this.pcMap)delete this.pcMap[c]}},d.prototype.mxpCancel=function(a){if(this.callState!=w.ENDED){this.sinch.log(new Notification(0,1,"Call CANCEL Received",a)),this.timeEnded=Date.now(),this.callState=w.ENDED;{Date.now()}this.setEndCause(x.CANCELED),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var b in this.pcMap)delete this.pcMap[b]}},d.prototype.mxpFail=function(a){this.sinch.log(new Notification(0,1,"Call FAILURE Received",a)),"message"==a.decrypted.bt&&(this.error=new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,""),this.error.message=a.decrypted.bd,this.error.mxp=a.decrypted),this.callFailure()},d.prototype.callFailure=function(){this.timeEnded=Date.now(),this.callState=w.ENDED,this.setEndCause(x.FAILURE),this.execListener("onCallEnded"),this.pc&&"closed"!=this.pc.signalingState&&this.pc.close(),delete this.pc;for(var a in this.pcMap)delete this.pcMap[a]},d.prototype.initPC=function(){var a=new t(this.webRtcConfig,{optional:[{DtlsSrtpKeyAgreement:!0}]});return this.outgoingStream&&a.addStream(this.outgoingStream),a.onaddstream=function(){}.bind(this),a.oniceconnectionstatechange=function(){},a.onicecandidate=function(b){b.candidate&&(this.sinch.log(new Notification(0,2,"Preparing ICE candidate for B",b.candidate)),b.candidate.cand=b.candidate.candidate,b.candidate.sdpMLI=b.candidate.sdpMLineIndex,setTimeout(function(){var c=Object.keys(this.pcMap).filter(function(b){return this.pcMap[b]===a}.bind(this))[0];this.sinch.log(new Notification(1,2,"Instantly sending ICE candidate for B",b.candidate)),this.sinch.mxp.callTxICECandidate(this,b.candidate,c).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending ICE candidate")})}.bind(this),this.sinch.mxp.sessionBuffert[this.callId]?0:500))}.bind(this),a.onnegotiationneeded=function(){},a.onremovestream=function(){},a.onsignalingstatechange=function(){},a},d.prototype.PSTNCall=function(a){var b=m.defer();return this.pc=this.initPC(),this.callDomain="pstn",this.setParticipants(this.sinch.user.userId,a),this.pc.createOffer(function(b){this.pc.setLocalDescription(b,function(){this.sinch.log(new Notification(0,1,"Created SDP Offer",b));var c={Cli:"",Destination:{type:"number",endpoint:a},CallId:this.callId,MediaChannels:["audio"],Headers:b};this.sinch.PSTNCall(c).then(function(a){this.sinch.log(new Notification(0,2,"Got SDP answer",a.Sdp)),this.sinch.mxp.sessionBuffert[this.callId]={key:a.EncryptionKey,body:a.Body};var b=new u(a.Sdp);this.pc.setRemoteDescription(b,function(){this.sinch.log(new Notification(1,2,"Successfully configured SDP Answer.",a.Sdp)),m.resolve()}.bind(this),function(a){throw setTimeout(function(){this.setEndCause(x.FAILURE),this.error=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,a),this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Cancel")}),this.callFailure(),m.reject(a)}.bind(this),2e3),new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error setting remote SDP")}.bind(this))}.bind(this)).fail(function(a){this.error=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,JSON.parse(a.response).message),this.callFailure(),m.reject(error)}.bind(this))}.bind(this),function(a){console.error("Error setting local Description, message: "+a)})}.bind(this),function(a){console.error("Error creating offer, message: "+a)},{mandatory:{OfferToReceiveVideo:!1,OfferToReceiveAudio:!0}}),b.promise},d.prototype.UserCall=function(a){var b=m.defer();this.callDomain="data",this.setParticipants(this.sinch.user.userId,a);var c={cli:"",destination:{type:"username",endpoint:a},callId:this.callId,MediaChannels:["audio"],headers:{p2p:"yes"}};return this.sinch.callData(c).then(function(a){this.sinch.log(new Notification(0,1,"Successfully initiated call, waiting for MXP response.",a)),this.sinch.mxp.sessionBuffert[this.callId]={key:a.EncryptionKey,body:a.Body},m.resolve()}.bind(this)).fail(function(a){this.error=new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,JSON.parse(a.response).message),this.callFailure(),m.reject(error)}.bind(this)),b.promise},d.prototype.ackIncomingCall=function(a){var b=m.defer();return this.sinch.log(new Notification(0,1,"Incoming call",this)),this.pcMap[a.decrypted.fi]=this.initPC(),this.pc=this.pcMap[a.decrypted.fi],this.pc.createOffer(function(a){this.pc.setLocalDescription(a,function(){this.sinch.log(new Notification(1,2,"Created SDP Offer",a)),this.sinch.mxp.sendSdpOffer(this,a).then(function(){this.progress()}.bind(this)).fail(function(a){console.error("Unhandled error in Call.ackIncomingCall",a)})}.bind(this),function(a){console.error("Error setting local Description, message: "+a)})}.bind(this),function(a){console.error("Error creating offer, message: "+a)},{mandatory:{OfferToReceiveVideo:!1,OfferToReceiveAudio:!0}}),b.promise},d.prototype.answer=function(){if(this.sinch.log(new Notification(0,1,"Answer call initiated, to answer()",this)),this.callState!=w.PROGRESSING)throw"undefined"==typeof outgoingStream?new SinchError(n.ErrorDomainOther,o.ApiApiCallFailed,"Outgoing stream not ready, can not answer."):new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Call in invalid state to answer.");this.sinch.mxp.joinIncomingCall(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending JOIN (pickup phone).")})},d.prototype.hangup=function(){if(this.callState==w.ESTABLISHED)this.sinch.mxp.callHangup(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Hangup")}),this.mxpHangup();else if(this.callState==w.PROGRESSING||this.callState==w.INITIATING)this.sinch.mxp.callCancel(this).fail(function(){throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error sending call Cancel")}),this.mxpHangup();else{if(this.callState==w.ENDED)throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Call already ended");this.mxpHangup()}},d.prototype.getCallId=function(){return this.callId},d.prototype.getDetails=function(){return{endCause:this.getEndCause(),endedTime:this.timeEnded,error:this.error,establishedTime:this.timeEstablished,startedTime:this.timeProgressing,duration:(this.timeEnded-this.timeEstablished)/1e3||0}},d.prototype.getDirection=function(){return this.callOutbound},d.prototype.getRemoteUserId=function(){throw new SinchError(n.ErrorDomainOther,o.OtherOther,"Not implemented.")},d.prototype.getState=function(){var a=Object.keys(w).filter(function(a){return w[a]===this.callState}.bind(this))[0];return a},d.prototype.getEndCause=function(){var a=Object.keys(x).filter(function(a){return x[a]===this.callEndCause}.bind(this))[0];return a},d.prototype.sendDTMF=function(a){return this.DTMFsender||(this.DTMFsender=this.pc.createDTMFSender(this.outgoingStream.getAudioTracks()[0])),this.DTMFsender&&this.DTMFsender.insertDTMF(a)},navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,e.prototype.addEventListener=function(a){this.eventListeners.push(a)},e.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},e.prototype.execListener=function(a,b){var c=0;return this.eventListeners.forEach(function(d){return c++,d[a]&&d[a](b)}.bind(this)),c},e.prototype.initStream=function(a){var b=m.defer();return void 0!==a?(this.sinch.log(new Notification(0,1,"Will wire customStream into call",a)),b.resolve(a)):void 0===this.localMediaStream?(this.sinch.log(new Notification(0,1,"Will retrieve new Mic for stream")),navigator.getUserMedia({video:!1,audio:!0},function(a){this.localMediaStream=a,b.resolve(this.localMediaStream)}.bind(this),function(a){console.error("Error retrieving media stream",a)})):(this.sinch.log(new Notification(0,1,"Will retrieve cached Mic for stream",this.localMediaStream)),b.resolve(this.localMediaStream)),b.promise},e.prototype.handleIncomingCall=function(a){this.sinch.log(new Notification(0,1,"Will handle incoming call",a));var b=new d(this.sinch,a.mxpSessionId);b.callDomain="data",b.setParticipants(a.decrypted.fu,this.sinch.user.userId),this.sinch.mxp.sessionBuffert[b.callId]={key:a.decrypted.nvps.key,body:a.decrypted.bd},b.clientMap[a.decrypted.fi]={fc:a.decrypted.fc,fd:a.decrypted.fd,fi:a.decrypted.fi,fs:a.decrypted.fs,fu:a.decrypted.fu},this.callBuffert[b.callId]=b,this.execListener("onIncomingCall",b)?this.initStream(this.incomingCallCustomStream).then(function(c){b.setStream(c),b.activeInstance=a.decrypted.fi,b.ackIncomingCall(a).catch(function(a){console.error("Error handling incoming call",a)})}.bind(this)):this.sinch.log(new SinchError(n.ErrorDomainSDK,o.SDKMissingCallback,"Missing handler, onIncomingCall."))},e.prototype.callUser=function(a,b,c){this.sinch.log(new Notification(0,1,"CallUser method called",a));var e=new d(this.sinch);return this.initStream(c).then(function(b){if(e.callState!=w.INITIATING)throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error executing user call. Incorrect call state.");e.setStream(b),e.UserCall(a),this.callBuffert[e.callId]=e}.bind(this)),e},e.prototype.callPhoneNumber=function(a,b,c){this.sinch.log(new Notification(0,1,"CallPhoneNumber method called",a));var e=new d(this.sinch);return this.initStream(c).then(function(b){if(e.callState!=w.INITIATING)throw new SinchError(n.ErrorDomainSDK,o.SDKInternalOther,"Error executing user call. Incorrect call state.");e.setStream(b),e.PSTNCall(a),this.callBuffert[e.callId]=e}.bind(this)),e};var w={INITIATING:{},PROGRESSING:{},ESTABLISHED:{},ENDED:{},TRANSFERRING:{}},x={CANCELED:6,DENIED:2,FAILURE:4,HUNG_UP:5,NO_ANSWER:3,OTHER_DEVICE_ANSWERED:7,TIMEOUT:1,TRANSFERRED:8};f.prototype.getMXPMessageObj=function(){var a=new k;return a.mxpSessionId=this.messageId,a.decrypted={bd:JSON.stringify({t:this.textBody})},this.headers&&(a.decrypted.nvps={ph:this.headers}),a.recipientIds=this.recipientIds,a},h.prototype.handleMessage=function(a){a.recipientIds=a.transportObj.participants.reduce(function(a,b){return a.push(b.destination.identity),a}.bind(this),[]);var b,c=!1;return this.messageBuffert[a.mxpSessionId]?b=this.messageBuffert[a.mxpSessionId]:(b=new f(a),this.messageBuffert[b.messageId]=b,c=!0),b.passedToHandler?!1:(this.eventListeners.forEach(function(a){return b.passedToHandler=!0,a.onIncomingMessage&&a.onIncomingMessage(b)}),c&&this.ackBuffert[b.messageId]&&(this.ackBuffert[b.messageId].forEach(function(a){this.ackMsg(a,b.messageId)}.bind(this)),delete this.ackBuffert[b.messageId]),!0)},h.prototype.addEventListener=function(a){this.eventListeners.push(a)},h.prototype.removeEventListener=function(a){this.eventListeners.splice(this.eventListeners.indexOf(a),1)},h.prototype.send=function(a,b,c){var d=m.defer();if(this.sinch.log(new Notification(0,1,"Send message method called"),d),!(a instanceof f))throw new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Unsupported message parameters",a);return b=b||function(a){return console.info("Message successfully sent"),a},c=c||function(a){console.error(a)},m.fcall(function(a){if(void 0===this.sinch.mxp){var b=new SinchError(n.ErrorDomainSDK,o.SDKUnexpectedCall,"Sinch is not ready yet");throw d.reject(b),b}if(a.sent)throw new SinchError(n.ErrorDomainSDK,o.SDKUnexpectedCall,"Message already sent");return a.sent=!0,a}.bind(this),a).then(this.sinch.mxp.sendMessage.bind(this.sinch.mxp)).then(b).then(d.resolve).fail(function(a){this.sinch.log(a),c(a),d.reject(a)}.bind(this)).progress(function(a){this.sinch.log(a),d.notify(a)}.bind(this)),d.promise},h.prototype.ackMsg=function(a,b){this.messageBuffert[b]&&-1===this.messageBuffert[b].delivered.indexOf(a)?(this.sinch.log(new MXPLog("Recieved ack from "+a+" for message",b)),this.messageBuffert[b].delivered.push(a),this.eventListeners.forEach(function(c){return c.onMessageDelivered&&c.onMessageDelivered(new g(a,b))}.bind(this))):(this.ackBuffert[b]||(this.ackBuffert[b]=[]),this.ackBuffert[b].push(a),this.sinch.log(new MXPLog("Got ack for message with non-existing messageId, storing in ackBuffert",b)))},h.prototype.newMessage=function(a,b,c){return"string"==typeof a&&(a=[a]),new f({recipientIds:a,textBody:b,senderId:this.sinch.user.userId,publicHeaders:c})},SinchError.prototype=Error.prototype,i.prototype.updateUser=function(a){var b=m.defer();return this.sinch.updateUser(a).then(function(a){this.userObj=a,b.resolve(a)}.bind(this)).fail(function(a){b.reject(a)}.bind(this)),b.promise},i.prototype.create=function(a){var b=m.defer(),c={password:a.password,identities:[]};return a.email&&(c.profile={contact:{email:a.email}},c.identities.push({type:"email",endpoint:a.email})),a.username&&c.identities.push({type:"username",endpoint:a.username}),a.number&&c.identities.push({type:"number",endpoint:a.number}),this.sinch.createUser(c).then(function(a){this.userObj=a,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve(a)}.bind(this)).fail(function(a){b.reject(new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}),b.promise},i.prototype.authenticate=function(a){if(a.sessionId&&a.sessionSecret)return a;var b=m.defer(),c="";if("email"in a){if(c=this.sinch.authenticate,""==a.email)return b.reject(new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Email is empty",a)),b.promise}else if("username"in a){if(c=this.sinch.authenticateUsername,""==a.username)return b.reject(new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Username is empty",a)),b.promise}else if("number"in a&&(c=this.sinch.authenticateNumber,""==a.number))return b.reject(new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Number is empty",a)),b.promise;if(a.authorization||a.userTicket){if(a.userTicket&&!a.user){var d=a.userTicket.split(":"),e=JSON.parse(atob(d[0]));"username"===!e.identity.type&&b.reject(new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"Username missing in userTicket JSON object.",a)),a.user={identities:[e.identity]}}this.userObj=a,this.userObj.authorization=a.authorization||a.userTicket,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve()}else c?c(a).then(function(a){this.userObj=a,this.userId=a.user.identities.reduce(function(a,b){return"username"===b.type?b.endpoint:a+""},""),b.resolve()}.bind(this)).fail(function(a){b.reject(new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}):b.reject(new SinchError(n.ErrorDomainSDK,o.SDKMissingParameter,"No valid identity or authentication ticket",a));return b.promise},i.prototype.initSessKeySecret=function(){var a=m.defer(),b={};return b.version={os:"web",platform:"web"},b.services={calling:[]},b.services.calling.push("online"),this.sinch.capabilities.messaging&&b.services.calling.push("im"),this.sinch.capabilities.calling&&(b.services.calling.push("voip"),b.services.calling.push("p2p")),b.authorization=this.userObj.authorization,b.expiresIn=86400,this.sinch.getInstance(b).then(function(b){this.sinch.config({sessionId:b.id,sessionSecret:b.secret}),a.resolve()}.bind(this)).fail(function(b){a.reject(new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,b.data.errorCode+" "+b.data.message,b.data))}),a.promise},i.prototype.resumeSession=function(a){var b=m.defer();return this.userId=a.userId,this.sinch.config(a),this.sinch.getUserProfile().then(function(a){this.userObj=a,b.resolve()}.bind(this)).fail(function(a){b.reject(new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,a.data.errorCode+" "+a.data.message,a.data))}),b.promise},i.prototype.getMXPConf=function(){var a=m.defer();return this.sinch.getConfiguration().then(function(b){this.mxpConfig=b,a.resolve()}.bind(this)).fail(function(b){a.reject(new SinchError(n.ErrorDomainApi,o.ApiApiCallFailed,b.data.errorCode+" "+b.data.message,b.data))}),a.promise},j.prototype.init=function(){var a=m.defer(),b=[],c={restore:!1,connect:function(c){b.push(c),3===b.length&&a.resolve()},channel:[this.rtcProfile.broadcastChannel,this.rtcProfile.transportChannel],callback:this._onmessagePubNub.bind(this),disconnect:this._ondisconnectPubNub.bind(this),error:this._onerrorPubNub.bind(this)};return this.broadcastPubNub.subscribe(c),c.channel=this.rtcProfile.signalChannel,this.signalPubNub.subscribe(c),a.promise},j.prototype.close=function(){this.broadcastPubNub.unsubscribe({channel:[this.rtcProfile.broadcastChannel,this.rtcProfile.transportChannel]}),this.signalPubNub.unsubscribe({channel:[this.rtcProfile.signalChannel]})},j.prototype._onmessagePubNub=function(a){this.sinch.log(new MXPLog("Recieved message",a)),m.fcall(this.collectFrames.bind(this),a).then(this.identifyKey.bind(this)).then(F).then(this.handleMessage.bind(this)).fail(function(a){a instanceof l?console.error("Decryption error. TODO: Buffer and try again later.."):this.handleError(a)}.bind(this))},j.prototype._ondisconnectPubNub=function(a){this.sinch.log(new MXPLog("Was disconnected!",a))},j.prototype._onerrorPubNub=function(a){var b=new MXPError(n.ErrorDomainNetwork,o.NetworkConnectionRefused,"PubNub error",a);this.sinch.log(b)},j.prototype.collectFrames=function(a){var b=m.defer(),c=a.split(" "),d=c[1]+c[2];if(1===c[4])b.resolve(a);else if((this.messageBuffert[d]||(this.messageBuffert[d]=[]))[c[3]]=c[5],this.messageBuffert[d].length==c[4]){var e=c[0]+" "+c[1]+" "+c[2]+" 0 1 ";for(var f in this.messageBuffert[d])e+=this.messageBuffert[d][f];void 0!==c[6]&&(e+=" "+c[6]),delete this.messageBuffert[d],this.sinch.log(new MXPLog("All frames collected and merged",e)),b.resolve(e)}else b.reject(new MXPLog("All frames not yet gathered",this.messageBuffert[d]));return b.promise},j.prototype.identifyKey=function(a){this.sinch.log(new MXPLog("Will identify key",a));var b,c=m.defer(),d=a.trim().split(" ");return void 0!==(b=d[6])?(this.sinch.log(new MXPLog("Transport key identified",a)),this.getTransport(b).then(function(e){c.resolve(new k({mxpSessionId:d[1],message:a,transportId:b,transportObj:e,key:this.transportBuffert[b].key,keyType:"T"}))}.bind(this)).fail(function(a){c.reject(a)}.bind(this))):void 0!==(this.sessionBuffert[d[1]]||{}).key?(this.sinch.log(new MXPLog("Session key in buffert identified",a)),c.resolve(new k({mxpSessionId:d[1],message:a,key:this.sessionBuffert[d[1]].key,keyType:"S"}))):(this.sinch.log(new MXPLog("No key, fall back on instance key",a)),c.resolve(new k({mxpSessionId:d[1],message:a,key:this.rtcProfile.key,keyType:"I"}))),c.promise},j.prototype.handleMessage=function(a){this.sinch.log(new MXPLog("Will handle message",a));var b=m.defer(),c=a.decrypted.md+"_"+(a.decrypted.bt||"null");return A[c]?(this.sinch.logMxp(new MXPIncoming(c,a)),A[c].call(this,a)):b.reject(new MXPError(n.ErrorDomainOther,o.OtherOther,"Handler not implemented: "+c,{})),b.promise},j.prototype.handleError=function(a){this.sinch.log(a),a.stack&&console.error(a.stack)},j.prototype.getTransport=function(a){var b=m.defer();if(a.constructor==String){var c=a;void 0!==this.transportBuffert[c]?(this.sinch.log(new MXPLog("Got transport from Buffert",this.transportBuffert[c])),b.resolve(this.transportBuffert[c])):this.sinch.getTransportById({transportId:c}).then(function(a){this.sinch.log(new MXPLog("Got new transport",a)),this.transportBuffert[c]=a,b.resolve(this.transportBuffert[c])}.bind(this))}else{if(a instanceof k||a instanceof Array){var d=a instanceof k?a.recipientIds:a;d=d.filter(function(a,b,c){return c.indexOf(a)===b});var e=d.indexOf(this.user.userId);e>-1&&d.splice(e,1);var f=[];d.forEach(function(a){if("string"==typeof a)f.push({identity:a});else if(a instanceof Object){for(var b in a)f.push({identity:a[b],type:b})}}),d.push(this.user.userId),d=d.sort();var g=JSON.stringify(d);if(this.transportBuffert[g]){var h=this.transportBuffert[g];this.sinch.log(new MXPLog("Got cached transport for recipient(s)",h)),a instanceof k?(a.transportObj=h,a.transportId=a.transportObj.transportId,b.resolve(a)):b.resolve(h)}else this.sinch.getTransportByParticipants(f).then(function(c){c.participants.unshift({channel:this.rtcProfile.transportChannel,destination:{identity:this.user.userId}});var e=c.participants.reduce(function(a,b){return a.push(b.destination.identity),a}.bind(this),[]),f=d.filter(function(a){return e.indexOf(a)<0});if(d.length!=c.participants.length)throw b.reject(new MXPError(n.ErrorDomainSDK,o.SDKInternalOther,"User does not exist",f)),new Error("");this.sinch.log(new MXPLog("Got new transport for recipient(s)",c)),this.transportBuffert[g]=c,a instanceof k?(a.transportObj=c,a.transportId=a.transportObj.transportId,b.resolve(a)):b.resolve(c)}.bind(this)).fail(function(a){b.reject(a)});return b.promise}b.reject(new MXPError(n.ErrorDomainOther,o.OtherOther,"Unknown transport ID",c))}return b.promise},j.prototype.sendMXP=function(a){var b=m.defer();return a.sub=a.sub||"broadcastPubNub",m.fcall(this.constructMXP.bind(this),a).then(this.identifyEnKey.bind(this)).then(E).then(this.splitFrames.bind(this)).then(this.getTxChannels.bind(this)).then(this.transmitFrames.bind(this)).then(function(a){b.resolve(a)}).fail(function(a){console.error(a.stack),console.error(a),b.reject(a)}).progress(function(a){b.notify(a)}),b.promise},j.prototype.constructMXP=function(a){return a.decrypted.fu=this.user.userId,a.decrypted.fi=this.sinch._sessionId,a.decrypted.fd=this.sinch._sessionId,a.decrypted.fc="",this.sinch.log(new MXPLog("Added meta data to MXP message",a)),a},j.prototype.identifyEnKey=function(a){return a.transportObj?(a.transportId=a.transportObj.transportId,a.key=a.transportObj.key,a.keyType="T",a.decrypted.fs=this.rtcProfile.transportChannel):(a.key=this.sessionBuffert[a.mxpSessionId].key,a.keyType="S",a.decrypted.fs=this.rtcProfile.signalChannel),this.sinch.log(new MXPLog("Identified Encoding Key",a)),a},j.prototype.splitFrames=function(a){a.encodedFrames=[];var b=1500;b-=a.mxpSessionId.length,b-=(a.transportId||"").length,b-=9,b-=6;do a.encodedFrames.push(a.encrypted.slice(0,b)),a.encrypted=a.encrypted.substring(b);while(a.encrypted.length>0);var c=Math.floor(2e9*Math.random());for(var d in a.encodedFrames)a.encodedFrames[d]="10 "+a.mxpSessionId+" "+(a.encodedFrames.length>1?c:"-")+" "+d+" "+a.encodedFrames.length+" "+a.encodedFrames[d],a.transportId&&(a.encodedFrames[d]+=" "+a.transportId);return this.sinch.log(new MXPLog("Split message into frames as needed",a)),a},j.prototype.getTxChannels=function(a){return a.txChannels=a.txChannels||[],a.transportObj&&a.transportObj.participants.forEach(function(b){a.txChannels.push(b.channel)}),this.sinch.log(new MXPLog("Identified Tx Channels",a)),a},j.prototype.transmitFrames=function(a){var b=m.defer();this.sinch.logMxp(new MXPOutgoing(a.decrypted.md+"_"+(a.decrypted.bt||"null"),a));var c,d=[];return c=a.transportObj?a.transportObj.participants.length*a.encodedFrames.length:a.encodedFrames.length,d.length==c&&b.resolve(a),a.txChannels.forEach(function(e){a.encodedFrames.forEach(function(f){this.sinch.log(new MXPLog("Transmitting [channel, frame]",[e,f])),this[a.sub].publish({channel:e,message:f,callback:function(e){d.push(e),b.notify(new Notification(d.length,c,"MXP Message send progress (frame Tx)")),d.length==c&&setTimeout(function(){b.resolve(a)},1e3)},error:function(a){console.error("PubNub: Error sending frame",a),b.reject(new MXPError(n.ErrorDomainOther,o.OtherOther,"PubNub: Error sending frame",a))}})}.bind(this))}.bind(this)),b.promise},MXPError.prototype=Error.prototype;var y=10;j.prototype.sendSdpOffer=function(a,b){var c=m.defer(),d=new k({mxpSessionId:a.callId},a);return d.decrypted.bd=JSON.stringify(b),d.decrypted.md=2,d.decrypted.bt="sdp",d.decrypted.bv=y,this.sendMXP(d).then(function(){c.resolve()}).fail(function(a){c.reject(a)}).progress(function(a){c.notify(a)}.bind(this)),c.promise},j.prototype.joinIncomingCall=function(a){var b=m.defer(),c=new k({mxpSessionId:a.callId},a);return c.decrypted.md=3,c.decrypted.bt="sdp",c.decrypted.bv=y,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},j.prototype.callJoined=function(a){var b=m.defer(),c=new k({mxpSessionId:a.callId},a);return c.decrypted.bd=JSON.stringify(a.clientMap[a.activeInstance]),c.decrypted.md=4,c.decrypted.bt="client",c.decrypted.bv=y,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},j.prototype.sendSdpAnswer=function(a,b,c){var d=m.defer(),e=new k({mxpSessionId:a.callId},a);return e.decrypted.bd=JSON.stringify(b),e.decrypted.md=10,e.decrypted.bt="sdp",e.decrypted.bv=y,e.decrypted.nvps=e.decrypted.nvps||{},e.decrypted.nvps.to=c||"undefined",this.sendMXP(e).then(function(){d.resolve()}).fail(function(a){d.reject(a)}).progress(function(a){d.notify(a)}.bind(this)),d.promise},j.prototype.callHangup=function(a){var b=m.defer(),c=new k({mxpSessionId:a.callId},a);return c.decrypted.md=5,c.decrypted.bv=y,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},j.prototype.callDeny=function(a){var b=m.defer(),c=new k({mxpSessionId:a.callId},a);return c.decrypted.md=6,c.decrypted.bv=y,this.sendMXP(c).then(function(){b.resolve()}).fail(function(a){b.reject(a)}).progress(function(a){b.notify(a)}.bind(this)),b.promise},j.prototype.callCancel=function(a,b){var c=m.defer(),d=new k({mxpSessionId:a.callId},a);return d.decrypted.md=7,d.decrypted.bv=y,d.decrypted.nvps=d.decrypted.nvps||{},d.decrypted.nvps.to=b,this.sendMXP(d).then(function(){c.resolve()}).fail(function(a){c.reject(a)
}).progress(function(a){c.notify(a)}.bind(this)),c.promise},j.prototype.callTxICECandidate=function(a,b,c){var d=m.defer(),e=new k({mxpSessionId:a.callId},a);return e.decrypted.bd=JSON.stringify(b),e.decrypted.md=10,e.decrypted.bt="sdp",e.decrypted.bv=y,e.decrypted.nvps=e.decrypted.nvps||{},e.decrypted.nvps.to=c||"undefined",this.sendMXP(e).then(function(){d.resolve()}).fail(function(a){d.reject(a)}).progress(function(a){d.notify(a)}.bind(this)),d.promise},j.prototype.msgToMe=function(a){return!a.decrypted.nvps||!a.decrypted.nvps.to||a.decrypted.nvps.to==this.sinch._sessionId};var z={"1_media":function(a){this.sinch.callClient.handleIncomingCall(a)},"2_media":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpAck(a)},"2_sdp":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpAckWithSdp(a)},"3_media":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoin(a)},"3_sdp":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoin(a)},"4_client":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpJoined(a)},"5_null":function(a){this.msgToMe(a)?this.sinch.callClient.callBuffert[a.mxpSessionId].mxpHangup(a):this.sinch.log(new Notification(0,1,"Received HUNG_UP message not meant for this instance, nvps.to header set to foreign instance id",a))},"6_null":function(a){this.msgToMe(a)?this.sinch.callClient.callBuffert[a.mxpSessionId].mxpDeny(a):this.sinch.log(new Notification(0,1,"Received DENIED message not meant for this instance, nvps.to header set to foreign instance id",a))},"7_null":function(a){this.msgToMe(a)?this.sinch.callClient.callBuffert[a.mxpSessionId].mxpCancel(a):this.sinch.log(new Notification(0,1,"Received CANCEL message not meant for this instance, nvps.to header set to foreign instance id",a))},"9_message":function(a){this.sinch.callClient.callBuffert[a.mxpSessionId].mxpFail(a)},"10_sdp":function(a){if(this.msgToMe(a)){var b=JSON.parse(a.decrypted.bd);"type"in b?this.sinch.callClient.callBuffert[a.mxpSessionId].mxpSdpAnswer(a):this.sinch.callClient.callBuffert[a.mxpSessionId].mxpInjectIce(a)}else this.sinch.log(new Notification(0,1,"Received SDP/CAND message not meant for this instance, nvps.to header set to foreign instance id",a))}},A=A||{};for(var B in z)A[B]=z[B];var C=10;j.prototype.sendMessage=function(a){var b=a.getMXPMessageObj(),c=m.defer();return b.decrypted.md=1,b.decrypted.bt="msg",b.decrypted.bv=C,this.getTransport(b).then(this.sendMXP.bind(this)).then(function(a){A["1_msg"].call(this,a),this.sinch.log(new MXPLog("Message sent to all participants",a)),c.resolve(this.sinch.messageClient.messageBuffert[a.mxpSessionId])}.bind(this)).fail(function(a){c.reject(a)}).progress(function(a){c.notify(a)}.bind(this)),c.promise},j.prototype.sendMsgAck=function(a){var b=new k({mxpSessionId:a.mxpSessionId});b.decrypted.md=2,b.decrypted.bt=a.decrypted.bt,b.decrypted.bv=C,b.transportObj=a.transportObj;var c=[];b.transportObj.participants.forEach(function(b){b.channel==a.decrypted.fs&&c.push(b)}.bind(this)),b.transportObj.participants=c,Object.keys(b.transportObj.participants).length>0&&(this.sinch.log(new MXPLog("Will send Ack",b)),this.sendMXP(b).then(function(b){this.sinch.log(new MXPLog("Sent ack",[a.decrypted.fu,b.channel]))}.bind(this)).fail(function(a){console.error(a)}))};var D={none:function(a){console.log("Null handler for message object: ",a)},"1_msg":function(a){var b=this.sinch.messageClient.handleMessage(a);b&&a.decrypted.fu!=this.user.userId&&this.sendMsgAck(a)},"2_msg":function(a){this.sinch.messageClient.ackMsg(a.decrypted.fu,a.mxpSessionId)}},A=A||{};for(var B in D)A[B]=D[B];var E=function(a){{var b=a.key,c=a.decrypted;a.mxpSessionId}try{var d=G.enc.Utf8.parse(JSON.stringify(c));b=G.enc.Base64.parse(b);var e=G.lib.WordArray.random(16),f=G.AES.encrypt(d,b,{iv:e}),g=G.enc.Hex.parse(e.toString(G.enc.Hex)+f.ciphertext.toString(G.enc.Hex))}catch(h){throw new l(n.ErrorDomainOther,o.OtherOther,"MXPEncrypt error: "+h.message,h)}return a.encrypted=g.toString(G.enc.Base64),a},F=function(a){try{var b=a.key,c=a.message,d=c.split(" ")[5],e=G.enc.Base64.parse(d),f=e.toString(G.enc.Hex),g=G.enc.Hex.parse(f.substr(0,32)),h=G.enc.Hex.parse(f.substr(32)),i=G.lib.CipherParams.create({ciphertext:h,salt:null}),j=G.AES.decrypt(i,G.enc.Base64.parse(b),{iv:g}),k=j.toString(G.enc.Utf8),m=k.indexOf("{"),p=k.lastIndexOf("}")+1;k=k.substring(m,p),a.decrypted=JSON.parse(k)}catch(q){throw new l(n.ErrorDomainOther,o.OtherOther,"MXPDecrypt error: "+q.message,q)}return a},G=G||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){function b(a,b,c,d,e,f,g){return a=a+(b&c|~b&d)+e+g,(a<<f|a>>>32-f)+b}function c(a,b,c,d,e,f,g){return a=a+(b&d|c&~d)+e+g,(a<<f|a>>>32-f)+b}function d(a,b,c,d,e,f,g){return a=a+(b^c^d)+e+g,(a<<f|a>>>32-f)+b}function e(a,b,c,d,e,f,g){return a=a+(c^(b|~d))+e+g,(a<<f|a>>>32-f)+b}for(var f=G,g=f.lib,h=g.WordArray,i=g.Hasher,g=f.algo,j=[],k=0;64>k;k++)j[k]=4294967296*a.abs(a.sin(k+1))|0;g=g.MD5=i.extend({_doReset:function(){this._hash=new h.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,f){for(var g=0;16>g;g++){var h=f+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var g=this._hash.words,h=a[f+0],i=a[f+1],k=a[f+2],l=a[f+3],m=a[f+4],n=a[f+5],o=a[f+6],p=a[f+7],q=a[f+8],r=a[f+9],s=a[f+10],t=a[f+11],u=a[f+12],v=a[f+13],w=a[f+14],x=a[f+15],y=g[0],z=g[1],A=g[2],B=g[3],y=b(y,z,A,B,h,7,j[0]),B=b(B,y,z,A,i,12,j[1]),A=b(A,B,y,z,k,17,j[2]),z=b(z,A,B,y,l,22,j[3]),y=b(y,z,A,B,m,7,j[4]),B=b(B,y,z,A,n,12,j[5]),A=b(A,B,y,z,o,17,j[6]),z=b(z,A,B,y,p,22,j[7]),y=b(y,z,A,B,q,7,j[8]),B=b(B,y,z,A,r,12,j[9]),A=b(A,B,y,z,s,17,j[10]),z=b(z,A,B,y,t,22,j[11]),y=b(y,z,A,B,u,7,j[12]),B=b(B,y,z,A,v,12,j[13]),A=b(A,B,y,z,w,17,j[14]),z=b(z,A,B,y,x,22,j[15]),y=c(y,z,A,B,i,5,j[16]),B=c(B,y,z,A,o,9,j[17]),A=c(A,B,y,z,t,14,j[18]),z=c(z,A,B,y,h,20,j[19]),y=c(y,z,A,B,n,5,j[20]),B=c(B,y,z,A,s,9,j[21]),A=c(A,B,y,z,x,14,j[22]),z=c(z,A,B,y,m,20,j[23]),y=c(y,z,A,B,r,5,j[24]),B=c(B,y,z,A,w,9,j[25]),A=c(A,B,y,z,l,14,j[26]),z=c(z,A,B,y,q,20,j[27]),y=c(y,z,A,B,v,5,j[28]),B=c(B,y,z,A,k,9,j[29]),A=c(A,B,y,z,p,14,j[30]),z=c(z,A,B,y,u,20,j[31]),y=d(y,z,A,B,n,4,j[32]),B=d(B,y,z,A,q,11,j[33]),A=d(A,B,y,z,t,16,j[34]),z=d(z,A,B,y,w,23,j[35]),y=d(y,z,A,B,i,4,j[36]),B=d(B,y,z,A,m,11,j[37]),A=d(A,B,y,z,p,16,j[38]),z=d(z,A,B,y,s,23,j[39]),y=d(y,z,A,B,v,4,j[40]),B=d(B,y,z,A,h,11,j[41]),A=d(A,B,y,z,l,16,j[42]),z=d(z,A,B,y,o,23,j[43]),y=d(y,z,A,B,r,4,j[44]),B=d(B,y,z,A,u,11,j[45]),A=d(A,B,y,z,x,16,j[46]),z=d(z,A,B,y,k,23,j[47]),y=e(y,z,A,B,h,6,j[48]),B=e(B,y,z,A,p,10,j[49]),A=e(A,B,y,z,w,15,j[50]),z=e(z,A,B,y,n,21,j[51]),y=e(y,z,A,B,u,6,j[52]),B=e(B,y,z,A,l,10,j[53]),A=e(A,B,y,z,s,15,j[54]),z=e(z,A,B,y,i,21,j[55]),y=e(y,z,A,B,q,6,j[56]),B=e(B,y,z,A,x,10,j[57]),A=e(A,B,y,z,o,15,j[58]),z=e(z,A,B,y,v,21,j[59]),y=e(y,z,A,B,m,6,j[60]),B=e(B,y,z,A,t,10,j[61]),A=e(A,B,y,z,k,15,j[62]),z=e(z,A,B,y,r,21,j[63]);g[0]=g[0]+y|0,g[1]=g[1]+z|0,g[2]=g[2]+A|0,g[3]=g[3]+B|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296);for(c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8),b.sigBytes=4*(c.length+1),this._process(),b=this._hash,c=b.words,d=0;4>d;d++)e=c[d],c[d]=16711935&(e<<8|e>>>24)|4278255360&(e<<24|e>>>8);return b},clone:function(){var a=i.clone.call(this);return a._hash=this._hash.clone(),a}}),f.MD5=i._createHelper(g),f.HmacMD5=i._createHmacHelper(g)}(Math);var G=G||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){for(var b=G,c=b.lib,d=c.WordArray,e=c.Hasher,c=b.algo,f=[],g=[],h=function(a){return 4294967296*(a-(0|a))|0},i=2,j=0;64>j;){var k;a:{k=i;for(var l=a.sqrt(k),m=2;l>=m;m++)if(!(k%m)){k=!1;break a}k=!0}k&&(8>j&&(f[j]=h(a.pow(i,.5))),g[j]=h(a.pow(i,1/3)),j++),i++}var n=[],c=c.SHA256=e.extend({_doReset:function(){this._hash=new d.init(f.slice(0))},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],e=c[1],f=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=0;64>m;m++){if(16>m)n[m]=0|a[b+m];else{var o=n[m-15],p=n[m-2];n[m]=((o<<25|o>>>7)^(o<<14|o>>>18)^o>>>3)+n[m-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+n[m-16]}o=l+((i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25))+(i&j^~i&k)+g[m]+n[m],p=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&e^d&f^e&f),l=k,k=j,j=i,i=h+o|0,h=f,f=e,e=d,d=o+p|0}c[0]=c[0]+d|0,c[1]=c[1]+e|0,c[2]=c[2]+f|0,c[3]=c[3]+h|0,c[4]=c[4]+i|0,c[5]=c[5]+j|0,c[6]=c[6]+k|0,c[7]=c[7]+l|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;return c[e>>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+14]=a.floor(d/4294967296),c[(e+64>>>9<<4)+15]=d,b.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var a=e.clone.call(this);return a._hash=this._hash.clone(),a}});b.SHA256=e._createHelper(c),b.HmacSHA256=e._createHmacHelper(c)}(Math),function(){var a=G,b=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(a,c){a=this._hasher=new a.init,"string"==typeof c&&(c=b.parse(c));var d=a.blockSize,e=4*d;c.sigBytes>e&&(c=a.finalize(c)),c.clamp();for(var f=this._oKey=c.clone(),g=this._iKey=c.clone(),h=f.words,i=g.words,j=0;d>j;j++)h[j]^=1549556828,i[j]^=909522486;f.sigBytes=g.sigBytes=e,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var b=this._hasher;return a=b.finalize(a),b.reset(),b.finalize(this._oKey.clone().concat(a))}})}(),function(){var a=G,b=a.lib.WordArray;a.enc.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp(),a=[];for(var e=0;c>e;e+=3)for(var f=(b[e>>>2]>>>24-8*(e%4)&255)<<16|(b[e+1>>>2]>>>24-8*((e+1)%4)&255)<<8|b[e+2>>>2]>>>24-8*((e+2)%4)&255,g=0;4>g&&c>e+.75*g;g++)a.push(d.charAt(f>>>6*(3-g)&63));if(b=d.charAt(64))for(;a.length%4;)a.push(b);return a.join("")},parse:function(a){var c=a.length,d=this._map,e=d.charAt(64);e&&(e=a.indexOf(e),-1!=e&&(c=e));for(var e=[],f=0,g=0;c>g;g++)if(g%4){var h=d.indexOf(a.charAt(g-1))<<2*(g%4),i=d.indexOf(a.charAt(g))>>>6-2*(g%4);e[f>>>2]|=(h|i)<<24-8*(f%4),f++}return b.create(e,f)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();var G=G||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(){var a=G,b=a.lib.WordArray;a.enc.Base64={stringify:function(a){var b=a.words,c=a.sigBytes,d=this._map;a.clamp(),a=[];for(var e=0;c>e;e+=3)for(var f=(b[e>>>2]>>>24-8*(e%4)&255)<<16|(b[e+1>>>2]>>>24-8*((e+1)%4)&255)<<8|b[e+2>>>2]>>>24-8*((e+2)%4)&255,g=0;4>g&&c>e+.75*g;g++)a.push(d.charAt(f>>>6*(3-g)&63));if(b=d.charAt(64))for(;a.length%4;)a.push(b);return a.join("")},parse:function(a){var c=a.length,d=this._map,e=d.charAt(64);e&&(e=a.indexOf(e),-1!=e&&(c=e));for(var e=[],f=0,g=0;c>g;g++)if(g%4){var h=d.indexOf(a.charAt(g-1))<<2*(g%4),i=d.indexOf(a.charAt(g))>>>6-2*(g%4);e[f>>>2]|=(h|i)<<24-8*(f%4),f++}return b.create(e,f)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(a){function b(a,b,c,d,e,f,g){return a=a+(b&c|~b&d)+e+g,(a<<f|a>>>32-f)+b}function c(a,b,c,d,e,f,g){return a=a+(b&d|c&~d)+e+g,(a<<f|a>>>32-f)+b}function d(a,b,c,d,e,f,g){return a=a+(b^c^d)+e+g,(a<<f|a>>>32-f)+b}function e(a,b,c,d,e,f,g){return a=a+(c^(b|~d))+e+g,(a<<f|a>>>32-f)+b}for(var f=G,g=f.lib,h=g.WordArray,i=g.Hasher,g=f.algo,j=[],k=0;64>k;k++)j[k]=4294967296*a.abs(a.sin(k+1))|0;g=g.MD5=i.extend({_doReset:function(){this._hash=new h.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(a,f){for(var g=0;16>g;g++){var h=f+g,i=a[h];a[h]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var g=this._hash.words,h=a[f+0],i=a[f+1],k=a[f+2],l=a[f+3],m=a[f+4],n=a[f+5],o=a[f+6],p=a[f+7],q=a[f+8],r=a[f+9],s=a[f+10],t=a[f+11],u=a[f+12],v=a[f+13],w=a[f+14],x=a[f+15],y=g[0],z=g[1],A=g[2],B=g[3],y=b(y,z,A,B,h,7,j[0]),B=b(B,y,z,A,i,12,j[1]),A=b(A,B,y,z,k,17,j[2]),z=b(z,A,B,y,l,22,j[3]),y=b(y,z,A,B,m,7,j[4]),B=b(B,y,z,A,n,12,j[5]),A=b(A,B,y,z,o,17,j[6]),z=b(z,A,B,y,p,22,j[7]),y=b(y,z,A,B,q,7,j[8]),B=b(B,y,z,A,r,12,j[9]),A=b(A,B,y,z,s,17,j[10]),z=b(z,A,B,y,t,22,j[11]),y=b(y,z,A,B,u,7,j[12]),B=b(B,y,z,A,v,12,j[13]),A=b(A,B,y,z,w,17,j[14]),z=b(z,A,B,y,x,22,j[15]),y=c(y,z,A,B,i,5,j[16]),B=c(B,y,z,A,o,9,j[17]),A=c(A,B,y,z,t,14,j[18]),z=c(z,A,B,y,h,20,j[19]),y=c(y,z,A,B,n,5,j[20]),B=c(B,y,z,A,s,9,j[21]),A=c(A,B,y,z,x,14,j[22]),z=c(z,A,B,y,m,20,j[23]),y=c(y,z,A,B,r,5,j[24]),B=c(B,y,z,A,w,9,j[25]),A=c(A,B,y,z,l,14,j[26]),z=c(z,A,B,y,q,20,j[27]),y=c(y,z,A,B,v,5,j[28]),B=c(B,y,z,A,k,9,j[29]),A=c(A,B,y,z,p,14,j[30]),z=c(z,A,B,y,u,20,j[31]),y=d(y,z,A,B,n,4,j[32]),B=d(B,y,z,A,q,11,j[33]),A=d(A,B,y,z,t,16,j[34]),z=d(z,A,B,y,w,23,j[35]),y=d(y,z,A,B,i,4,j[36]),B=d(B,y,z,A,m,11,j[37]),A=d(A,B,y,z,p,16,j[38]),z=d(z,A,B,y,s,23,j[39]),y=d(y,z,A,B,v,4,j[40]),B=d(B,y,z,A,h,11,j[41]),A=d(A,B,y,z,l,16,j[42]),z=d(z,A,B,y,o,23,j[43]),y=d(y,z,A,B,r,4,j[44]),B=d(B,y,z,A,u,11,j[45]),A=d(A,B,y,z,x,16,j[46]),z=d(z,A,B,y,k,23,j[47]),y=e(y,z,A,B,h,6,j[48]),B=e(B,y,z,A,p,10,j[49]),A=e(A,B,y,z,w,15,j[50]),z=e(z,A,B,y,n,21,j[51]),y=e(y,z,A,B,u,6,j[52]),B=e(B,y,z,A,l,10,j[53]),A=e(A,B,y,z,s,15,j[54]),z=e(z,A,B,y,i,21,j[55]),y=e(y,z,A,B,q,6,j[56]),B=e(B,y,z,A,x,10,j[57]),A=e(A,B,y,z,o,15,j[58]),z=e(z,A,B,y,v,21,j[59]),y=e(y,z,A,B,m,6,j[60]),B=e(B,y,z,A,t,10,j[61]),A=e(A,B,y,z,k,15,j[62]),z=e(z,A,B,y,r,21,j[63]);g[0]=g[0]+y|0,g[1]=g[1]+z|0,g[2]=g[2]+A|0,g[3]=g[3]+B|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;c[e>>>5]|=128<<24-e%32;var f=a.floor(d/4294967296);for(c[(e+64>>>9<<4)+15]=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),c[(e+64>>>9<<4)+14]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8),b.sigBytes=4*(c.length+1),this._process(),b=this._hash,c=b.words,d=0;4>d;d++)e=c[d],c[d]=16711935&(e<<8|e>>>24)|4278255360&(e<<24|e>>>8);return b},clone:function(){var a=i.clone.call(this);return a._hash=this._hash.clone(),a}}),f.MD5=i._createHelper(g),f.HmacMD5=i._createHmacHelper(g)}(Math),function(){var a=G,b=a.lib,c=b.Base,d=b.WordArray,b=a.algo,e=b.EvpKDF=c.extend({cfg:c.extend({keySize:4,hasher:b.MD5,iterations:1}),init:function(a){this.cfg=this.cfg.extend(a)},compute:function(a,b){for(var c=this.cfg,e=c.hasher.create(),f=d.create(),g=f.words,h=c.keySize,c=c.iterations;g.length<h;){i&&e.update(i);var i=e.update(a).finalize(b);e.reset();for(var j=1;c>j;j++)i=e.finalize(i),e.reset();f.concat(i)}return f.sigBytes=4*h,f}});a.EvpKDF=function(a,b,c){return e.create(c).compute(a,b)}}(),G.lib.Cipher||function(a){var b=G,c=b.lib,d=c.Base,e=c.WordArray,f=c.BufferedBlockAlgorithm,g=b.enc.Base64,h=b.algo.EvpKDF,i=c.Cipher=f.extend({cfg:d.extend(),createEncryptor:function(a,b){return this.create(this._ENC_XFORM_MODE,a,b)},createDecryptor:function(a,b){return this.create(this._DEC_XFORM_MODE,a,b)},init:function(a,b,c){this.cfg=this.cfg.extend(c),this._xformMode=a,this._key=b,this.reset()},reset:function(){f.reset.call(this),this._doReset()},process:function(a){return this._append(a),this._process()},finalize:function(a){return a&&this._append(a),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(a){return{encrypt:function(b,c,d){return("string"==typeof c?o:n).encrypt(a,b,c,d)},decrypt:function(b,c,d){return("string"==typeof c?o:n).decrypt(a,b,c,d)}}}});c.StreamCipher=i.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var j=b.mode={},k=function(b,c,d){var e=this._iv;e?this._iv=a:e=this._prevBlock;for(var f=0;d>f;f++)b[c+f]^=e[f]},l=(c.BlockCipherMode=d.extend({createEncryptor:function(a,b){return this.Encryptor.create(a,b)},createDecryptor:function(a,b){return this.Decryptor.create(a,b)},init:function(a,b){this._cipher=a,this._iv=b}})).extend();l.Encryptor=l.extend({processBlock:function(a,b){var c=this._cipher,d=c.blockSize;k.call(this,a,b,d),c.encryptBlock(a,b),this._prevBlock=a.slice(b,b+d)}}),l.Decryptor=l.extend({processBlock:function(a,b){var c=this._cipher,d=c.blockSize,e=a.slice(b,b+d);c.decryptBlock(a,b),k.call(this,a,b,d),this._prevBlock=e}}),j=j.CBC=l,l=(b.pad={}).Pkcs7={pad:function(a,b){for(var c=4*b,c=c-a.sigBytes%c,d=c<<24|c<<16|c<<8|c,f=[],g=0;c>g;g+=4)f.push(d);c=e.create(f,c),a.concat(c)},unpad:function(a){a.sigBytes-=255&a.words[a.sigBytes-1>>>2]}},c.BlockCipher=i.extend({cfg:i.cfg.extend({mode:j,padding:l}),reset:function(){i.reset.call(this);var a=this.cfg,b=a.iv,a=a.mode;if(this._xformMode==this._ENC_XFORM_MODE)var c=a.createEncryptor;else c=a.createDecryptor,this._minBufferSize=1;this._mode=c.call(a,this,b&&b.words)},_doProcessBlock:function(a,b){this._mode.processBlock(a,b)},_doFinalize:function(){var a=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){a.pad(this._data,this.blockSize);var b=this._process(!0)}else b=this._process(!0),a.unpad(b);return b},blockSize:4});var m=c.CipherParams=d.extend({init:function(a){this.mixIn(a)},toString:function(a){return(a||this.formatter).stringify(this)}}),j=(b.format={}).OpenSSL={stringify:function(a){var b=a.ciphertext;return a=a.salt,(a?e.create([1398893684,1701076831]).concat(a).concat(b):b).toString(g)},parse:function(a){a=g.parse(a);var b=a.words;if(1398893684==b[0]&&1701076831==b[1]){var c=e.create(b.slice(2,4));b.splice(0,4),a.sigBytes-=16}return m.create({ciphertext:a,salt:c})}},n=c.SerializableCipher=d.extend({cfg:d.extend({format:j}),encrypt:function(a,b,c,d){d=this.cfg.extend(d);var e=a.createEncryptor(c,d);return b=e.finalize(b),e=e.cfg,m.create({ciphertext:b,key:c,iv:e.iv,algorithm:a,mode:e.mode,padding:e.padding,blockSize:a.blockSize,formatter:d.format})},decrypt:function(a,b,c,d){return d=this.cfg.extend(d),b=this._parse(b,d.format),a.createDecryptor(c,d).finalize(b.ciphertext)},_parse:function(a,b){return"string"==typeof a?b.parse(a,this):a}}),b=(b.kdf={}).OpenSSL={execute:function(a,b,c,d){return d||(d=e.random(8)),a=h.create({keySize:b+c}).compute(a,d),c=e.create(a.words.slice(b),4*c),a.sigBytes=4*b,m.create({key:a,iv:c,salt:d})}},o=c.PasswordBasedCipher=n.extend({cfg:n.cfg.extend({kdf:b}),encrypt:function(a,b,c,d){return d=this.cfg.extend(d),c=d.kdf.execute(c,a.keySize,a.ivSize),d.iv=c.iv,a=n.encrypt.call(this,a,b,c.key,d),a.mixIn(c),a},decrypt:function(a,b,c,d){return d=this.cfg.extend(d),b=this._parse(b,d.format),c=d.kdf.execute(c,a.keySize,a.ivSize,b.salt),d.iv=c.iv,n.decrypt.call(this,a,b,c.key,d)}})}(),function(){for(var a=G,b=a.lib.BlockCipher,c=a.algo,d=[],e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=[],m=[],n=[],o=0;256>o;o++)n[o]=128>o?o<<1:o<<1^283;for(var p=0,q=0,o=0;256>o;o++){var r=q^q<<1^q<<2^q<<3^q<<4,r=r>>>8^255&r^99;d[p]=r,e[r]=p;var s=n[p],t=n[s],u=n[t],v=257*n[r]^16843008*r;f[p]=v<<24|v>>>8,g[p]=v<<16|v>>>16,h[p]=v<<8|v>>>24,i[p]=v,v=16843009*u^65537*t^257*s^16843008*p,j[r]=v<<24|v>>>8,k[r]=v<<16|v>>>16,l[r]=v<<8|v>>>24,m[r]=v,p?(p=s^n[n[n[u^s]]],q^=n[n[q]]):p=q=1}var w=[0,1,2,4,8,16,32,64,128,27,54],c=c.AES=b.extend({_doReset:function(){for(var a=this._key,b=a.words,c=a.sigBytes/4,a=4*((this._nRounds=c+6)+1),e=this._keySchedule=[],f=0;a>f;f++)if(c>f)e[f]=b[f];else{var g=e[f-1];f%c?c>6&&4==f%c&&(g=d[g>>>24]<<24|d[g>>>16&255]<<16|d[g>>>8&255]<<8|d[255&g]):(g=g<<8|g>>>24,g=d[g>>>24]<<24|d[g>>>16&255]<<16|d[g>>>8&255]<<8|d[255&g],g^=w[f/c|0]<<24),e[f]=e[f-c]^g}for(b=this._invKeySchedule=[],c=0;a>c;c++)f=a-c,g=c%4?e[f]:e[f-4],b[c]=4>c||4>=f?g:j[d[g>>>24]]^k[d[g>>>16&255]]^l[d[g>>>8&255]]^m[d[255&g]]},encryptBlock:function(a,b){this._doCryptBlock(a,b,this._keySchedule,f,g,h,i,d)},decryptBlock:function(a,b){var c=a[b+1];a[b+1]=a[b+3],a[b+3]=c,this._doCryptBlock(a,b,this._invKeySchedule,j,k,l,m,e),c=a[b+1],a[b+1]=a[b+3],a[b+3]=c},_doCryptBlock:function(a,b,c,d,e,f,g,h){for(var i=this._nRounds,j=a[b]^c[0],k=a[b+1]^c[1],l=a[b+2]^c[2],m=a[b+3]^c[3],n=4,o=1;i>o;o++)var p=d[j>>>24]^e[k>>>16&255]^f[l>>>8&255]^g[255&m]^c[n++],q=d[k>>>24]^e[l>>>16&255]^f[m>>>8&255]^g[255&j]^c[n++],r=d[l>>>24]^e[m>>>16&255]^f[j>>>8&255]^g[255&k]^c[n++],m=d[m>>>24]^e[j>>>16&255]^f[k>>>8&255]^g[255&l]^c[n++],j=p,k=q,l=r;p=(h[j>>>24]<<24|h[k>>>16&255]<<16|h[l>>>8&255]<<8|h[255&m])^c[n++],q=(h[k>>>24]<<24|h[l>>>16&255]<<16|h[m>>>8&255]<<8|h[255&j])^c[n++],r=(h[l>>>24]<<24|h[m>>>16&255]<<16|h[j>>>8&255]<<8|h[255&k])^c[n++],m=(h[m>>>24]<<24|h[j>>>16&255]<<16|h[k>>>8&255]<<8|h[255&l])^c[n++],a[b]=p,a[b+1]=q,a[b+2]=r,a[b+3]=m},keySize:8});a.AES=b._createHelper(c)}(),b.exports=c},{q:2}]},{},[3])(3)});